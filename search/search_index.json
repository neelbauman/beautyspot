{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"\ud83c\udf11 beautyspot","text":"<ul> <li>https://neelbauman.github.io/beautyspot/</li> <li>https://pypi.org/project/beautyspot/</li> <li>https://opensource.org/licenses/MIT</li> </ul>"},{"location":"#concept","title":"Concept","text":"<p>\"You focus on the logic. We handle the rest.\"</p> <p>\u751f\u6210AI\u306e\u30d0\u30c3\u30c1\u51e6\u7406\u3084\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3001\u91cd\u3044\u8a08\u7b97\u51e6\u7406\u3092\u884c\u3046\u969b\u3001\u672c\u8cea\u7684\u306a\u30ed\u30b8\u30c3\u30af\u4ee5\u5916\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3092\u66f8\u304f\u306e\u306f\u5927\u5909\u3067\u3059\u3088\u306d\u3002</p> <ul> <li>API\u5236\u9650\u3092\u5b88\u308b\u305f\u3081\u306e <code>time.sleep()</code> \u3084\u30c8\u30fc\u30af\u30f3\u8a08\u7b97</li> <li>\u9014\u4e2d\u505c\u6b62\u3057\u305f\u969b\u306e\u30ea\u30ab\u30d0\u30ea\u51e6\u7406\uff08 <code>try-except</code> \u3068 <code>continue</code> \uff09</li> <li>\u7d50\u679c\u3092\u4fdd\u5b58\u30fb\u30ed\u30fc\u30c9\u3059\u308b\u305f\u3081\u306e\u30d5\u30a1\u30a4\u30ebI/O</li> <li>\u91cd\u8907\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9632\u3050\u305f\u3081\u306eID\u7ba1\u7406</li> </ul> <p><code>beautyspot</code> \u306f\u3001\u3042\u306a\u305f\u306e\u30b3\u30fc\u30c9\u306b\u300c\u9ed2\u5b50/\u307b\u304f\u308d\uff08\u30c7\u30b3\u30ec\u30fc\u30bf\uff09\u300d\u3092\u4e00\u3064\u4ed8\u3051\u308b\u3060\u3051\u3067\u3001\u3053\u308c\u3089\u306e\u9762\u5012\u306a\u30a4\u30f3\u30d5\u30e9\u5236\u5fa1\u3092\u3059\u3079\u3066\u5f15\u304d\u53d7\u3051\u308b\u300c\u9ed2\u5b50/\u304f\u308d\u3053\u300d\u3067\u3059\u3002</p> <p>\u8efd\u91cf\u3067\u5c11\u306a\u3044\u4f9d\u5b58\u6027\u3067\u3001\u30ed\u30fc\u30ab\u30eb\u958b\u767a\u306b\u3066\u3053\u306e\u3088\u3046\u306a\u30a4\u30f3\u30d5\u30e9\u3092\u624b\u8efd\u306b\u5229\u7528\u3067\u304d\u308b\u3053\u3068\u3092\u76ee\u6307\u3057\u3066\u958b\u767a\u3055\u308c\u3066\u3044\u307e\u3059\u3002</p> <p>v1.0.0 \u3067\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306e\u5b89\u5168\u6027\uff08Secure by Default\uff09 \u3068 \u62e1\u5f35\u6027\uff08Extensibility\uff09 \u3092\u5f37\u5316\u3057\u307e\u3057\u305f\u3002</p>"},{"location":"#installation","title":"\u26a1 Installation","text":"<pre><code>pip install beautyspot\n</code></pre> <ul> <li>Standard: <code>msgpack</code> \u304c\u540c\u68b1\u3055\u308c\u3001\u9ad8\u901f\u304b\u3064\u5b89\u5168\u306b\u52d5\u4f5c\u3057\u307e\u3059\u3002</li> <li>Options:<ul> <li><code>pip install \"beautyspot[s3]\"</code>: S3\u30b9\u30c8\u30ec\u30fc\u30b8\u3092\u5229\u7528\u3059\u308b\u5834\u5408</li> <li><code>pip install \"beautyspot[dashboard]\"</code>: \u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u3092\u5229\u7528\u3059\u308b\u5834\u5408</li> <li><code>pip install \"beautyspot[all]\"</code>: \u5168\u90e8\u5165\u308a</li> </ul> </li> </ul>"},{"location":"#quick-start","title":"\ud83d\ude80 Quick Start","text":"<p>\u95a2\u6570\u306b <code>@project.task</code> \u3092\u4ed8\u3051\u308b\u3060\u3051\u3067\u3001\u305d\u306e\u95a2\u6570\u304a\u3088\u3073\u5165\u51fa\u529b\u306f\u6c38\u7d9a\u5316\u3055\u308c\u3001\u540c\u3058\u8a08\u7b97\u7121\u99c4\u306b\u591a\u91cd\u306b\u7e70\u308a\u8fd4\u3059\u3053\u3068\u3092\u83ef\u9e97\u306b\u56de\u907f\u3057\u307e\u3059\u3002</p> <pre><code>import time\nimport beautyspot as bs\n\n# \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u5b9a\u7fa9\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\u3067 \"./my_experiment.db\" \u3092\u4f5c\u6210\uff09\nproject = bs.Project(\"my_experiment\")\n\n@project.task\ndef heavy_process(text):\n    # \u5b9f\u884c\u306b\u6642\u9593\u304c\u304b\u304b\u308b\u51e6\u7406\u3084\u3001\u8ab2\u91d1\u3055\u308c\u308bAPI\u30b3\u30fc\u30eb\n    time.sleep(2)\n    return f\"Processed: {text}\"\n\n# \u30d0\u30c3\u30c1\u51e6\u7406\ninputs = [\"A\", \"B\", \"C\", \"A\"]\n\nfor i in inputs:\n    # 1. \u521d\u56de\u306e \"A\", \"B\", \"C\" \u306f\u5b9f\u884c\u3055\u308c\u308b\n    # 2. \u6700\u5f8c\u306e \"A\" \u306f\u3001DB\u304b\u3089\u30ad\u30e3\u30c3\u30b7\u30e5\u304c\u5373\u5ea7\u306b\u8fd4\u308b\uff08\u5b9f\u884c\u6642\u95930\u79d2\uff09\n    # 3. \u9014\u4e2d\u505c\u6b62\u3057\u3066\u3082\u3001\u6b21\u56de\u306f\u300c\u672a\u5b8c\u4e86\u306e\u30bf\u30b9\u30af\u300d\u3060\u3051\u304c\u5b9f\u884c\u3055\u308c\u308b\n    print(heavy_process(i))\n</code></pre>"},{"location":"#key-features","title":"\ud83d\udca1 Key Features","text":""},{"location":"#1-handle-any-data-size-and-securely","title":"1. Handle Any Data Size (and Securely)","text":"<p>\"No more Pickle risks.\"</p> <p>v1.0.0 \u304b\u3089\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6\u306b Msgpack \u3092\u63a1\u7528\u3057\u307e\u3057\u305f\u3002 Python\u6a19\u6e96\u306e <code>pickle</code> \u3068\u7570\u306a\u308a\u3001\u4fe1\u983c\u3067\u304d\u306a\u3044\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u8fbc\u3093\u3067\u3082\u4efb\u610f\u306e\u30b3\u30fc\u30c9\u5b9f\u884c\uff08RCE\uff09\u306e\u30ea\u30b9\u30af\u304c\u3042\u308a\u307e\u305b\u3093\u3002</p> <p>\u95a2\u6570\u306e\u623b\u308a\u5024\u304c\u5de8\u5927\u306b\u306a\u308b\u5834\u5408\uff08\u753b\u50cf\u3001\u97f3\u58f0\u3001\u5927\u898f\u6a21\u306aHTML\u306a\u3069\uff09\u3001<code>save_blob=True</code> \u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002 <code>beautyspot</code> \u304c\u81ea\u52d5\u7684\u306b\u30c7\u30fc\u30bf\u3092\u5916\u90e8\u30b9\u30c8\u30ec\u30fc\u30b8\uff08Local/S3\uff09\u3078\u9003\u304c\u3057\u3001DB\u306b\u306f\u8efd\u91cf\u306a\u53c2\u7167\u306e\u307f\u3092\u6b8b\u3057\u307e\u3059\u3002</p> <pre><code># Large Data -&gt; Blob\u306b\u9000\u907f (Msgpack\u3067\u4fdd\u5b58)\n@project.task(save_blob=True)\ndef download_image(url):\n    return requests.get(url).content\n</code></pre>"},{"location":"#2-custom-type-registration","title":"2. Custom Type Registration","text":"<p>Numpy\u914d\u5217\u3084\u81ea\u4f5c\u30af\u30e9\u30b9\u306a\u3069\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\u578b\u3082\u3001\u5909\u63db\u30ed\u30b8\u30c3\u30af\u3092\u767b\u9332\u3059\u308b\u3053\u3068\u3067\u5b89\u5168\u306b\u6271\u3048\u307e\u3059\u3002</p> <pre><code>import numpy as np\n\n# \u30ab\u30b9\u30bf\u30e0\u578b\u306e\u5909\u63db\u30ed\u30b8\u30c3\u30af\u3092\u767b\u9332\n# code: 0-127 \u306e\u4e00\u610f\u306aID\nproject.register_type(\n    type_=np.ndarray,\n    code=10,\n    encoder=lambda x: x.tobytes(),\n    decoder=lambda b: np.frombuffer(b)\n)\n\n@project.task(save_blob=True)\ndef create_array():\n    return np.array([1, 2, 3])\n</code></pre>"},{"location":"#3-flexible-backend-with-dependency-injection","title":"3. Flexible Backend with Dependency Injection","text":"<p>\"Start simple, scale later.\"</p> <p>\u901a\u5e38\u306f\u30d1\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3060\u3051\u3067 SQLite \u304c\u4f7f\u3048\u307e\u3059\u304c\u3001\u5927\u898f\u6a21\u306a\u4e26\u5217\u51e6\u7406\u3084\u30c6\u30b9\u30c8\u306e\u305f\u3081\u306b\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u81ea\u7531\u306b\u5dee\u3057\u66ff\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\uff08Dependency Injection\uff09\u3002</p> <pre><code>from beautyspot.db import SQLiteTaskDB\n\n# A. Standard Usage (Path string)\n# \u5185\u90e8\u3067 SQLiteTaskDB(\"./data.db\") \u304c\u751f\u6210\u3055\u308c\u308b\nproject = bs.Project(\"app\", db=\"./data.db\")\n\n# B. Advanced Usage (Injection)\n# \u72ec\u81ea\u306e\u8a2d\u5b9a\u3092\u884c\u3063\u305fDB\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3084\u3001\u30a4\u30f3\u30e1\u30e2\u30eaDB\u3001\n# \u3042\u308b\u3044\u306f\u81ea\u4f5c\u306e PostgresTaskDB \u306a\u3069\u3092\u6ce8\u5165\u53ef\u80fd\ndb_instance = SQLiteTaskDB(\"./data.db\")\nproject = bs.Project(\"app\", db=db_instance)\n</code></pre> <p>\ud83d\udcd6 Guide: PostgreSQL \u3084 MySQL \u3092\u4f7f\u7528\u3059\u308b\u30ab\u30b9\u30bf\u30e0\u30a2\u30c0\u30d7\u30bf\u306e\u4f5c\u6210\u65b9\u6cd5\u306f docs/advanced/custom_backend.md \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p>"},{"location":"#4-declarative-rate-limiting","title":"4. Declarative Rate Limiting","text":"<p>API\u306e\u5236\u9650\uff08\u4f8b\uff1a1\u5206\u9593\u306b1\u4e07\u30c8\u30fc\u30af\u30f3\uff09\u3092\u5b88\u308b\u305f\u3081\u306b\u3001\u8907\u96d1\u306a\u30b9\u30ea\u30fc\u30d7\u51e6\u7406\u3092\u66f8\u304f\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002 GCRA (Generic Cell Rate Algorithm) \u30d9\u30fc\u30b9\u306e\u9ad8\u6027\u80fd\u306a\u30ea\u30df\u30c3\u30bf\u30fc\u304c\u3001\u30d0\u30fc\u30b9\u30c8\uff08\u96c6\u4e2d\u30a2\u30af\u30bb\u30b9\uff09\u3092\u9632\u304e\u306a\u304c\u3089\u30b9\u30e0\u30fc\u30ba\u306b\u5b9f\u884c\u3092\u5236\u5fa1\u3057\u307e\u3059\u3002</p> <pre><code># 1\u5206\u9593\u306b 50,000 \u30c8\u30fc\u30af\u30f3\u307e\u3067\u306b\u5236\u9650\nproject = bs.Project(\"openai_batch\", tpm=50000)\n\ndef calc_cost(text):\n    return len(text)\n\n@project.task\n@project.limiter(cost=calc_cost)  # \u30ea\u30c8\u30e9\u30a4\u6642\u3082\u542b\u3081\u3066\u81ea\u52d5\u5236\u5fa1\ndef call_api(text):\n    return api.generate(text)\n</code></pre>"},{"location":"#migration-guide-v0x-v100","title":"\u26a0\ufe0f Migration Guide (v0.x -&gt; v1.0.0)","text":"<p>v1.0.0 \u3067\u306f\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6\u304c <code>pickle</code> \u304b\u3089 <code>msgpack</code> \u306b\u5909\u66f4\u3055\u308c\u305f\u305f\u3081\u3001v0.x \u3067\u4f5c\u6210\u3055\u308c\u305f\u30ad\u30e3\u30c3\u30b7\u30e5\uff08\u7279\u306b <code>save_blob=True</code> \u306e\u30c7\u30fc\u30bf\uff09\u3068\u306f\u4e92\u63db\u6027\u304c\u3042\u308a\u307e\u305b\u3093\u3002</p> <p>\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u6642\u306f\u3001\u53e4\u3044 <code>.db</code> \u30d5\u30a1\u30a4\u30eb\u304a\u3088\u3073 <code>blobs/</code> \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u524a\u9664\u3057\u3001\u30af\u30ea\u30fc\u30f3\u306a\u72b6\u614b\u3067\u958b\u59cb\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\u3002</p>"},{"location":"#dashboard-result-viewer","title":"\ud83d\udcca Dashboard (Result Viewer)","text":"<p>\"Minimal viewer, not a full tracer.\"</p> <p>\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u306f\u3001\u3042\u304f\u307e\u3067**\u300c\u5b9f\u884c\u72b6\u6cc1\uff08\u623b\u308a\u5024\uff09\u306e\u78ba\u8a8d\u300d\u3068\u300c\u30ad\u30e3\u30c3\u30b7\u30e5DB\u304c\u7834\u7dbb\u3057\u3066\u3044\u306a\u3044\u304b\u306e\u78ba\u8a8d\u300d**\u306b\u7279\u5316\u3057\u3066\u3044\u307e\u3059\u3002 Blob\u3068\u3057\u3066\u9000\u907f\u3055\u308c\u305f\u5de8\u5927\u306a\u623b\u308a\u5024\u3082\u3001\u3053\u3053\u304b\u3089\u81ea\u52d5\u7684\u306b\u5fa9\u5143\u3057\u3066\u30d7\u30ec\u30d3\u30e5\u30fc\u53ef\u80fd\u3067\u3059\uff08Mermaid, Graphviz, Image, JSON\u7b49\uff09\u3002</p> <pre><code># \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306eDB\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3057\u3066\u8d77\u52d5\n$ beautyspot ui ./my_experiment.db\n</code></pre> <p>Note: \u4ed8\u5c5e\u306e\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e SQLite \u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u5c02\u7528 \u3067\u3059\u3002 \u30ab\u30b9\u30bf\u30e0\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\uff08PostgreSQL\u7b49\uff09\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u3053\u306e\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u306f\u5229\u7528\u3067\u304d\u307e\u305b\u3093\u3002\u305d\u306e\u5834\u5408\u306f Metabase \u3084 SQL \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u7b49\u306e\u5229\u7528\u3092\u63a8\u5968\u3057\u307e\u3059\u3002</p>"},{"location":"#license","title":"\ud83e\udd1d License","text":"<p>MIT License</p>"},{"location":"adr/0000-adr-example/","title":"Manage Executor Lifecycle via Instance Ownership and Weak References","text":""},{"location":"adr/0000-adr-example/#context-and-problem-statement","title":"Context and Problem Statement / \u30b3\u30f3\u30c6\u30ad\u30b9\u30c8","text":"<p><code>src/beautyspot/core.py</code> \u306b\u304a\u3044\u3066\u3001\u975e\u540c\u671f\u30bf\u30b9\u30af\u306eIO\u30aa\u30d5\u30ed\u30fc\u30c9\u7528\u306b <code>ThreadPoolExecutor</code> \u304c\u30b0\u30ed\u30fc\u30d0\u30eb\u5909\u6570 <code>_io_executor</code> \u3068\u3057\u3066\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u3002</p> <p>\u3053\u306e\u5b9f\u88c5\u306b\u306f\u4ee5\u4e0b\u306e\u8ab2\u984c\u304c\u3042\u308b\uff1a</p> <ol> <li>\u30ea\u30bd\u30fc\u30b9\u5236\u5fa1\u306e\u6b20\u5982: \u30b9\u30ec\u30c3\u30c9\u6570\uff08<code>max_workers=4</code>\uff09\u304c\u30cf\u30fc\u30c9\u30b3\u30fc\u30c9\u3055\u308c\u3066\u304a\u308a\u3001\u30e6\u30fc\u30b6\u30fc\u304c\u5b9f\u884c\u74b0\u5883\uff08AWS Lambda\u3001\u5f37\u529b\u306a\u30b5\u30fc\u30d0\u30fc\u7b49\uff09\u306b\u5408\u308f\u305b\u3066\u8abf\u6574\u3067\u304d\u306a\u3044\u3002</li> <li>\u30be\u30f3\u30d3\u30d7\u30ed\u30bb\u30b9: \u30d7\u30ed\u30bb\u30b9\u7d42\u4e86\u6642\u306b\u660e\u793a\u7684\u306a\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u304c\u884c\u308f\u308c\u306a\u3044\u305f\u3081\u3001\u74b0\u5883\u306b\u3088\u3063\u3066\u306f\u30be\u30f3\u30d3\u30d7\u30ed\u30bb\u30b9\u5316\u3059\u308b\u30ea\u30b9\u30af\u304c\u3042\u308b\u3002</li> <li>\u30c6\u30b9\u30c8\u56f0\u96e3\u6027: \u30b0\u30ed\u30fc\u30d0\u30eb\u5909\u6570\u306f\u30e2\u30c3\u30af\u5316\u304c\u96e3\u3057\u304f\u3001\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u306e\u5206\u96e2\u3092\u59a8\u3052\u308b\u3002</li> </ol> <p>\u4ee3\u66ff\u6848\u3068\u3057\u3066 <code>with</code> \u6587\uff08Context Manager\uff09\u306b\u3088\u308b\u7ba1\u7406\u3082\u691c\u8a0e\u3055\u308c\u305f\u304c\u3001<code>beautyspot</code> \u306e\u300c\u30c7\u30b3\u30ec\u30fc\u30bf\u3092\u4ed8\u4e0e\u3059\u308b\u3060\u3051\u3067\u52d5\u4f5c\u3059\u308b\u300d\u3068\u3044\u3046\u7c21\u6613\u306a\u5229\u7528\u4f53\u9a13\uff08DX\uff09\u3092\u640d\u306a\u3046\u305f\u3081\u3001\u63a1\u7528\u306b\u306f\u81f3\u3089\u306a\u304b\u3063\u305f\u3002\u30e6\u30fc\u30b6\u30fc\u30b3\u30fc\u30c9\u3092\u5909\u66f4\u3055\u305b\u305a\u306b\u3001\u5b89\u5168\u306b\u30ea\u30bd\u30fc\u30b9\u3092\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u3059\u308b\u4ed5\u7d44\u307f\u304c\u5fc5\u8981\u3067\u3042\u308b\u3002</p>"},{"location":"adr/0000-adr-example/#decision-drivers","title":"Decision Drivers / \u8981\u6c42","text":"<ul> <li>Developer Experience (DX): \u30e6\u30fc\u30b6\u30fc\u306b <code>shutdown()</code> \u306e\u547c\u3073\u51fa\u3057\u3084 <code>with</code> \u6587\u3092\u5f37\u5236\u3057\u305f\u304f\u306a\u3044\u3002</li> <li>Configurability: \u30b9\u30ec\u30c3\u30c9\u6570\u3084 Executor \u306e\u5b9f\u88c5\u3092\u30e6\u30fc\u30b6\u30fc\u304c\u5236\u5fa1\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u305f\u3044\u3002</li> <li>Safety: \u30d7\u30ed\u30bb\u30b9\u7d42\u4e86\u6642\u3084\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u7834\u68c4\u6642\u306b\u3001\u78ba\u5b9f\u306b\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u3092\u9589\u3058\u305f\u3044\u3002</li> <li>Memory Safety: \u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u51e6\u7406\u306e\u767b\u9332\u306b\u3088\u3063\u3066\u3001\u30e1\u30e2\u30ea\u30ea\u30fc\u30af\uff08\u5faa\u74b0\u53c2\u7167\uff09\u3092\u5f15\u304d\u8d77\u3053\u3057\u3066\u306f\u306a\u3089\u306a\u3044\u3002</li> </ul>"},{"location":"adr/0000-adr-example/#considered-options","title":"Considered Options / \u691c\u8a0e","text":"<ul> <li>Option 1: \u73fe\u72b6\u7dad\u6301\uff08\u30b0\u30ed\u30fc\u30d0\u30eb\u5909\u6570\u306e\u307e\u307e\uff09\u3002</li> <li>Option 2: <code>Project</code> \u3092 Context Manager \u5316\u3057\u3001<code>__exit__</code> \u3067 <code>shutdown()</code> \u3092\u547c\u3076\u3002</li> <li>Option 3: <code>atexit</code> \u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3044\u3001\u7d42\u4e86\u6642\u306b <code>shutdown()</code> \u3092\u547c\u3076\u3002</li> <li>Option 4: \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u7ba1\u7406\u306b\u5909\u66f4\u3057\u3001<code>weakref.finalize</code> \u3067\u81ea\u52d5\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u3092\u884c\u3046\u3002</li> </ul>"},{"location":"adr/0000-adr-example/#decision-outcome","title":"Decision Outcome / \u6c7a\u5b9a","text":"<p>Chosen option: Option 4.</p> <p><code>Project</code> \u30af\u30e9\u30b9\u306e\u8a2d\u8a08\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3059\u308b\uff1a</p> <ol> <li>Executor\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5316:     \u30b0\u30ed\u30fc\u30d0\u30eb\u5909\u6570\u3092\u5ec3\u6b62\u3057\u3001<code>Project</code> \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3054\u3068\u306b <code>ThreadPoolExecutor</code> \u3092\u4fdd\u6301\u3059\u308b\u3002</li> <li>Dependency Injection (DI):     \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3067\u5916\u90e8 <code>Executor</code> \u306e\u6ce8\u5165\u3092\u8a31\u53ef\u3059\u308b\u3002</li> <li>\u6240\u6709\u6a29\u3068\u8cac\u4efb\u306e\u5206\u96e2:<ul> <li>\u5916\u90e8\u6ce8\u5165 (<code>executor</code> \u5f15\u6570\u3042\u308a): <code>Project</code> \u306f\u305d\u308c\u3092\u501f\u7528\u3059\u308b\u306e\u307f\u3002\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u306e\u8cac\u4efb\u306f\u30e6\u30fc\u30b6\u30fc\uff08\u547c\u3073\u51fa\u3057\u5143\uff09\u306b\u3042\u308b\u305f\u3081\u3001\u81ea\u52d5\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u306f\u884c\u308f\u306a\u3044\u3002</li> <li>\u5185\u90e8\u751f\u6210 (<code>executor</code> \u5f15\u6570\u306a\u3057): <code>Project</code> \u304c\u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb\u3092\u7ba1\u7406\u3059\u308b\u8cac\u4efb\u3092\u6301\u3064\u3002</li> </ul> </li> <li>\u81ea\u52d5\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7:     \u5185\u90e8\u751f\u6210\u3057\u305f\u5834\u5408\u306b\u9650\u308a\u3001<code>weakref.finalize</code> \u3092\u4f7f\u7528\u3057\u3066\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3092\u81ea\u52d5\u5316\u3059\u308b\u3002</li> </ol>"},{"location":"adr/0000-adr-example/#technical-details-why-weakreffinalize-instead-of-atexit","title":"Technical Details / \u6280\u8853\u8a73\u7d30: Why <code>weakref.finalize</code> instead of <code>atexit</code>?","text":"<p>\u5358\u7d14\u306a <code>atexit.register(self.shutdown)</code> \u3092\u63a1\u7528\u3057\u306a\u304b\u3063\u305f\u7406\u7531\u306f\u3001\u30e1\u30e2\u30ea\u30ea\u30fc\u30af\uff08\u5faa\u74b0\u53c2\u7167\uff09\u306e\u30ea\u30b9\u30af \u3067\u3042\u308b\u3002</p> <ul> <li>\u554f\u984c\u70b9: <code>atexit</code> \u30ec\u30b8\u30b9\u30c8\u30ea\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30e1\u30bd\u30c3\u30c9\uff08<code>self.shutdown</code>\uff09\u3092\u767b\u9332\u3059\u308b\u3068\u3001<code>atexit</code> \u304c <code>self</code> \u3078\u306e\u5f37\u53c2\u7167\uff08Strong Reference\uff09\u3092\u4fdd\u6301\u3057\u7d9a\u3051\u308b\u3002\u3053\u308c\u306b\u3088\u308a\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5b9f\u884c\u4e2d\u306b <code>Project</code> \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u4e0d\u8981\u306b\u306a\u3063\u3066\u3082\u30ac\u30d9\u30fc\u30b8\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\uff08GC\uff09\u3055\u308c\u305a\u3001\u30e1\u30e2\u30ea\u30ea\u30fc\u30af\u3092\u5f15\u304d\u8d77\u3053\u3059\u3002\u3053\u308c\u3092\u9632\u3050\u306b\u306f <code>atexit.unregister</code> \u304c\u5fc5\u8981\u306b\u306a\u308b\u304c\u3001\u7ba1\u7406\u304c\u8907\u96d1\u306b\u306a\u308b\u3002</li> <li>\u89e3\u6c7a\u7b56: <code>weakref.finalize(self, func, *args)</code> \u3092\u63a1\u7528\u3059\u308b\u3002<ul> <li><code>self</code> \u304cGC\u3055\u308c\u305f\u6642\u70b9\u3067\u3001\u5373\u5ea7\u306b <code>func</code>\uff08\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u51e6\u7406\uff09\u304c\u5b9f\u884c\u3055\u308c\u308b\u3002</li> <li>\u30d7\u30ed\u30b0\u30e9\u30e0\u7d42\u4e86\u6642\u307e\u3067 <code>self</code> \u304c\u751f\u5b58\u3057\u3066\u3044\u305f\u5834\u5408\u3082\u3001<code>atexit</code> \u76f8\u5f53\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067 <code>func</code> \u304c\u5b9f\u884c\u3055\u308c\u308b\u3002</li> <li>\u91cd\u8981: \u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u95a2\u6570 <code>_shutdown_executor</code> \u306f <code>staticmethod</code> \u3068\u3057\u3001\u5f15\u6570\u306b\u306f <code>self</code> \u3067\u306f\u306a\u304f <code>self.executor</code> \u306e\u307f\u3092\u6e21\u3059\u3002\u3053\u308c\u306b\u3088\u308a\u3001\u30d5\u30a1\u30a4\u30ca\u30e9\u30a4\u30b6\u304c <code>self</code> \u3092\u53c2\u7167\u3057\u7d9a\u3051\u3066\u5bff\u547d\u3092\u5ef6\u3070\u3057\u3066\u3057\u307e\u3046\u4e8b\u6545\u3092\u9632\u3050\u3002</li> </ul> </li> </ul> <pre><code># Implementation Sketch\nclass Project:\n    def __init__(self, ...):\n        # ...\n        self.executor = ThreadPoolExecutor(...)\n        # self \u3092\u53c2\u7167\u3057\u306a\u3044\u3088\u3046\u3001executor \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3060\u3051\u3092\u6e21\u3059\n        self._finalizer = weakref.finalize(self, self._shutdown_executor, self.executor)\n\n    @staticmethod\n    def _shutdown_executor(executor):\n        executor.shutdown(wait=True)\n</code></pre>"},{"location":"adr/0000-adr-example/#consequences","title":"Consequences / \u6c7a\u5b9a","text":"<ul> <li>Positive:<ul> <li>\u30e6\u30fc\u30b6\u30fc\u306f\u30ea\u30bd\u30fc\u30b9\u7ba1\u7406\u3092\u610f\u8b58\u3059\u308b\u5fc5\u8981\u304c\u306a\u304f\u306a\u308a\u3001API\u3082\u30b7\u30f3\u30d7\u30eb\u306b\u4fdd\u305f\u308c\u308b\u3002</li> <li><code>Project</code> \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304cGC\u3055\u308c\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u3082\u56de\u53ce\u3055\u308c\u308b\u305f\u3081\u3001\u30ea\u30bd\u30fc\u30b9\u52b9\u7387\u304c\u826f\u3044\u3002</li> <li>DI\u306b\u3088\u308a\u3001\u30c6\u30b9\u30c8\u6642\u306b\u30e2\u30c3\u30afExecutor\u3092\u5dee\u3057\u8fbc\u3080\u3053\u3068\u304c\u5bb9\u6613\u306b\u306a\u308b\u3002</li> </ul> </li> <li>Negative:<ul> <li><code>core.py</code> \u306e\u5b9f\u88c5\u306b\u304a\u3044\u3066\u3001GC\u306e\u6319\u52d5\u3068 <code>weakref</code> \u306e\u4ed5\u69d8\u3092\u7406\u89e3\u3057\u305f\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u304c\u5fc5\u8981\u306b\u306a\u308a\u3001\u5185\u90e8\u7684\u306a\u8907\u96d1\u6027\u304c\u82e5\u5e72\u5897\u3059\u3002</li> <li><code>Project</code> \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u5927\u91cf\u306b\u751f\u6210\u30fb\u7834\u68c4\u3059\u308b\u3088\u3046\u306a\u7279\u6b8a\u306a\u4f7f\u3044\u65b9\u3092\u3057\u305f\u5834\u5408\u3001\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u306e\u751f\u6210\u30b3\u30b9\u30c8\u304c\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u306b\u306a\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\uff08\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u30b7\u30f3\u30b0\u30eb\u30c8\u30f3\u7684\u306a\u5229\u7528\u3092\u63a8\u5968\u3059\u308b\u3053\u3068\u3067\u7de9\u548c\u3059\u308b\uff09\u3002</li> </ul> </li> </ul>"},{"location":"adr/0001-stable-argument-hashing/","title":"1. Stable Hashing for Function Arguments","text":""},{"location":"adr/0001-stable-argument-hashing/#context","title":"Context / \u30b3\u30f3\u30c6\u30ad\u30b9\u30c8","text":"<p><code>beautyspot</code> \u306e\u30b3\u30a2\u6a5f\u80fd\u3067\u3042\u308b\u300c\u95a2\u6570\u306e\u30e1\u30e2\u5316\uff08\u30ad\u30e3\u30c3\u30b7\u30e5\uff09\u300d\u306b\u304a\u3044\u3066\u3001\u95a2\u6570\u306e\u5f15\u6570 (<code>args</code>, <code>kwargs</code>) \u304b\u3089\u4e00\u610f\u306a\u30ad\u30e3\u30c3\u30b7\u30e5\u30ad\u30fc\u3092\u751f\u6210\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002</p> <p>\u521d\u671f\u5b9f\u88c5 (<code>v0.1.0</code>) \u3067\u306f\u3001<code>json.dumps</code> \u304c\u5931\u6557\u3057\u305f\u5834\u5408\u306e\u30d5\u30a9\u30fc\u30eb\u30d0\u30c3\u30af\u3068\u3057\u3066 <code>str((args, kwargs))</code> \u306e\u30cf\u30c3\u30b7\u30e5\u5024\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3057\u305f\u3002</p> <p>\u3057\u304b\u3057\u3001Python\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306e <code>__str__</code> / <code>__repr__</code> \u5b9f\u88c5\u306f\u3001\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u30e1\u30e2\u30ea\u30a2\u30c9\u30ec\u30b9\uff08\u4f8b: <code>&lt;MyObject at 0x10a...&gt;</code>\uff09\u3092\u542b\u3080\u3053\u3068\u304c\u591a\u304f\u3042\u308a\u307e\u3059\u3002</p> <p>\u3053\u308c\u306b\u3088\u308a\u4ee5\u4e0b\u306e\u554f\u984c\u304c\u767a\u751f\u3057\u3066\u3044\u307e\u3057\u305f\uff1a</p> <ol> <li>\u518d\u8d77\u52d5\u3054\u3068\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u7121\u52b9\u5316: \u30d7\u30ed\u30bb\u30b9\u3092\u518d\u8d77\u52d5\u3059\u308b\u3068\u30e1\u30e2\u30ea\u30a2\u30c9\u30ec\u30b9\u304c\u5909\u308f\u308a\u3001\u540c\u3058\u5165\u529b\u5024\u3067\u3082\u30cf\u30c3\u30b7\u30e5\u304c\u5909\u308f\u3063\u3066\u3057\u307e\u3046\u3002</li> <li>\u5206\u6563\u74b0\u5883\u3067\u306e\u4e0d\u6574\u5408: \u7570\u306a\u308b\u30de\u30b7\u30f3\uff08\u3042\u308b\u3044\u306f\u7570\u306a\u308b\u30d7\u30ed\u30bb\u30b9\uff09\u3067\u5b9f\u884c\u3057\u305f\u5834\u5408\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u30ad\u30fc\u304c\u4e00\u81f4\u3057\u306a\u3044\u3002</li> </ol> <p>\u5916\u90e8\u30e9\u30a4\u30d6\u30e9\u30ea\uff08<code>joblib</code> \u7b49\uff09\u3092\u4f7f\u3048\u3070\u89e3\u6c7a\u3057\u307e\u3059\u304c\u3001<code>beautyspot</code> \u306f\u8efd\u91cf\u306a\u300c\u9ed2\u5b50\u300d\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u76ee\u6307\u3057\u3066\u304a\u308a\u3001\u4f9d\u5b58\u95a2\u4fc2\u3092\u5897\u3084\u3057\u305f\u304f\u3042\u308a\u307e\u305b\u3093\u3002</p>"},{"location":"adr/0001-stable-argument-hashing/#decision","title":"Decision / \u6c7a\u5b9a","text":"<p>\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u306e <code>json</code> \u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u7528\u3057\u3001\u72ec\u81ea\u306e <code>default</code> \u30b7\u30ea\u30a2\u30e9\u30a4\u30b6 (<code>_stable_serialize_default</code>) \u3092\u5b9f\u88c5\u3059\u308b\u3053\u3068\u3067\u3001\u4f9d\u5b58\u95a2\u4fc2\u306a\u3057\u3067 \u5805\u7262\u306a\u30cf\u30c3\u30b7\u30e5\u751f\u6210\u3092\u5b9f\u73fe\u3057\u307e\u3059\u3002</p> <p>\u5177\u4f53\u7684\u306b\u306f\u4ee5\u4e0b\u306e\u6226\u7565\u3092\u63a1\u7528\u3057\u307e\u3059\uff1a</p> <ol> <li>Set/Frozenset\u306e\u30bd\u30fc\u30c8: JSON\u306f\u9806\u5e8f\u3092\u6301\u305f\u306a\u3044\u96c6\u5408\u3092\u6271\u3048\u306a\u3044\u305f\u3081\u3001<code>sorted(list(obj))</code> \u3067\u30ea\u30b9\u30c8\u5316\u3057\u3001\u9806\u5e8f\u3092\u4fdd\u8a3c\u3057\u307e\u3059\u3002</li> <li>\u30ab\u30b9\u30bf\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u8f9e\u66f8\u5316: <code>__dict__</code> \u307e\u305f\u306f <code>__slots__</code> \u3092\u53c2\u7167\u3057\u3001\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u300c\u4e2d\u8eab\u306e\u5024\u300d\u3092\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u5bfe\u8c61\u3068\u3057\u307e\u3059\u3002\u3053\u308c\u306b\u3088\u308a\u3001\u30e1\u30e2\u30ea\u30a2\u30c9\u30ec\u30b9\u3078\u306e\u4f9d\u5b58\u3092\u6392\u9664\u3057\u307e\u3059\u3002</li> <li>Bytes\u578b: 16\u9032\u6570\u6587\u5b57\u5217 (<code>hex</code>) \u306b\u5909\u63db\u3057\u307e\u3059\u3002</li> <li>\u6700\u7d42\u624b\u6bb5: \u305d\u308c\u3067\u3082\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3067\u304d\u306a\u3044\u578b\uff08\u5faa\u74b0\u53c2\u7167\u306a\u3069\uff09\u306b\u3064\u3044\u3066\u306f\u3001\u4f8b\u5916\u7684\u306b <code>str()</code> \u3092\u4f7f\u7528\u3057\u307e\u3059\uff08\u3053\u306e\u5834\u5408\u306e\u307f\u4e0d\u5b89\u5b9a\u306b\u306a\u308b\u30ea\u30b9\u30af\u3092\u8a31\u5bb9\u3057\u307e\u3059\uff09\u3002</li> </ol>"},{"location":"adr/0001-stable-argument-hashing/#consequences","title":"Consequences / \u7d50\u679c","text":"<ul> <li> <p>\u30e1\u30ea\u30c3\u30c8:</p> <ul> <li>\u30a2\u30d7\u30ea\u518d\u8d77\u52d5\u5f8c\u3082\u30ad\u30e3\u30c3\u30b7\u30e5\u304c\u6709\u52b9\u306b\u6a5f\u80fd\u3059\u308b\uff08\u6c38\u7d9a\u5316\u306e\u4fe1\u983c\u6027\u5411\u4e0a\uff09\u3002</li> <li><code>pydantic</code> \u30e2\u30c7\u30eb\u3084 <code>dataclass</code> \u3082\u8a2d\u5b9a\u306a\u3057\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u53ef\u80fd\u306b\u306a\u308b\u3002</li> <li>\u5916\u90e8\u4f9d\u5b58\uff08<code>numpy</code>, <code>joblib</code> \u7b49\uff09\u3092\u5897\u3084\u3055\u305a\u306b\u6e08\u3080\u3002</li> </ul> </li> <li> <p>\u30c7\u30e1\u30ea\u30c3\u30c8:</p> <ul> <li>\u5358\u306a\u308b <code>str()</code> \u5909\u63db\u3088\u308a\u3082\u3001\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u51e6\u7406\u306e\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\uff08CPU\u30b3\u30b9\u30c8\uff09\u304c\u308f\u305a\u304b\u306b\u5897\u52a0\u3059\u308b\u3002</li> <li>\u5faa\u74b0\u53c2\u7167\u3092\u6301\u3064\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u6e21\u3055\u308c\u305f\u5834\u5408\u306e\u5b8c\u5168\u306a\u89e3\u6c7a\u7b56\u3067\u306f\u306a\u3044\uff08\u305f\u3060\u3057\u3001\u30bf\u30b9\u30af\u306e\u5165\u529b\u5f15\u6570\u3068\u3057\u3066\u306f\u7a00\u3067\u3042\u308b\u3068\u5224\u65ad\uff09\u3002</li> </ul> </li> </ul>"},{"location":"adr/0002-robust-rate-limiter/","title":"2. Smooth Rate Limiter (GCRA)","text":""},{"location":"adr/0002-robust-rate-limiter/#context","title":"Context / \u30b3\u30f3\u30c6\u30ad\u30b9\u30c8","text":"<p><code>beautyspot</code> \u306e\u30ec\u30fc\u30c8\u5236\u9650\u6a5f\u80fd (<code>limiter</code>) \u306b\u304a\u3044\u3066\u3001\u4ee5\u4e0b\u306e\u8ab2\u984c\u304c\u3042\u3063\u305f\u3002</p> <ol> <li>Idle Burst: \u30c8\u30fc\u30af\u30f3\u30d0\u30b1\u30c3\u30c8\u65b9\u5f0f\u3067\u306f\u3001\u30a2\u30a4\u30c9\u30eb\u4e2d\u306b\u30c8\u30fc\u30af\u30f3\u304c\u6e9c\u307e\u308a\u3001\u518d\u958b\u76f4\u5f8c\u306b\u30d0\u30fc\u30b9\u30c8\uff08\u96c6\u4e2d\u30a2\u30af\u30bb\u30b9\uff09\u304c\u767a\u751f\u3057\u3066\u3057\u307e\u3046\u3002\u3053\u308c\u3092\u9632\u3050\u305f\u3081\u306b\u5bb9\u91cf(<code>capacity</code>)\u3092\u5c0f\u3055\u304f\u3059\u308b\u3068\u3001\u4eca\u5ea6\u306f\u5de8\u5927\u306a\u30b3\u30b9\u30c8\u3092\u6301\u3064\u30bf\u30b9\u30af\u304c\u5b9f\u884c\u3067\u304d\u306a\u304f\u306a\u308b\uff08\u30c7\u30c3\u30c9\u30ed\u30c3\u30af\uff09\u554f\u984c\u304c\u767a\u751f\u3059\u308b\u3002</li> <li>Start Dash Prevention: \u30d7\u30ed\u30bb\u30b9\u8d77\u52d5\u76f4\u5f8c\u306b\u8907\u6570\u306e\u30bf\u30b9\u30af\u304c\u540c\u6642\u306b\u8d70\u308b\u306e\u3092\u9632\u304e\u305f\u3044\u304c\u3001\u6700\u521d\u306e1\u56de\u76ee\u307e\u3067\u5f85\u305f\u3055\u308c\u308b\u306e\u306f\u907f\u3051\u305f\u3044\u3002</li> <li>Clock Dependency: \u30b7\u30b9\u30c6\u30e0\u6642\u523b\u306e\u5909\u66f4\u306b\u5805\u7262\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002</li> <li>Max Cost Guard: <code>tokens_per_minute</code> \u3092\u5358\u767a\u30bf\u30b9\u30af\u306e\u30b3\u30b9\u30c8\u4e0a\u9650\u3068\u3059\u308b\u3002<ul> <li>\u3053\u308c\u3092\u8d85\u3048\u308b\u30b3\u30b9\u30c8\u304c <code>consume()</code> \u306b\u6e21\u3055\u308c\u305f\u5834\u5408\u3001\u5373\u5ea7\u306b <code>ValueError</code> \u3092\u9001\u51fa\u3059\u308b\u3002</li> <li>\u7406\u7531: API\u306e\u7269\u7406\u7684\u306a\u30ec\u30fc\u30c8\u5236\u9650\u3092\u8d85\u3048\u308b\u30ea\u30af\u30a8\u30b9\u30c8\u306f\u3001\u5f85\u6a5f\u3057\u305f\u3068\u3053\u308d\u3067\u6210\u529f\u3059\u308b\u898b\u8fbc\u307f\u304c\u8584\u304f\u3001\u65e9\u671f\u306b\u8a2d\u5b9a\u30df\u30b9\u3084\u5165\u529b\u30df\u30b9\u3092\u30e6\u30fc\u30b6\u30fc\u306b\u901a\u77e5\u3059\u3079\u304d\u3067\u3042\u308b\u305f\u3081\u3002</li> </ul> </li> </ol>"},{"location":"adr/0002-robust-rate-limiter/#decision","title":"Decision / \u6c7a\u5b9a","text":"<p>\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u30c8\u30fc\u30af\u30f3\u30d0\u30b1\u30c3\u30c8\u304b\u3089 GCRA (Generic Cell Rate Algorithm)\u3001\u3042\u308b\u3044\u306f \"Leaky Bucket as a Meter\" \u3068\u547c\u3070\u308c\u308b\u65b9\u5f0f\u306b\u5909\u66f4\u3059\u308b\u3002</p> <ul> <li>\u7406\u8ad6\u7684\u5230\u9054\u6642\u523b (TAT: Theoretical Arrival Time) \u3092\u7ba1\u7406\u3059\u308b\u3002</li> <li>\u30bf\u30b9\u30af\u304c\u6765\u308b\u3068\u3001\u305d\u306e\u30b3\u30b9\u30c8\u5206\u3060\u3051 TAT \u3092\u672a\u6765\u3078\u9032\u3081\u308b\u3002</li> <li><code>\u73fe\u5728\u6642\u523b &lt; TAT</code> \u306a\u3089\u3070\u3001\u305d\u306e\u5dee\u5206\u3060\u3051\u5f85\u6a5f\uff08sleep\uff09\u3057\u3066\u304b\u3089\u5b9f\u884c\u3059\u308b\u3002</li> <li><code>\u73fe\u5728\u6642\u523b &gt;= TAT</code> \uff08\u30a2\u30a4\u30c9\u30eb\u72b6\u614b\uff09\u306a\u3089\u3070\u3001TAT \u3092\u73fe\u5728\u6642\u523b\u306b\u30ea\u30bb\u30c3\u30c8\u3057\u3066\u304b\u3089\u8a08\u7b97\u3059\u308b\uff08\u904e\u53bb\u306e\u8caf\u91d1\u306f\u6368\u3066\u308b\uff09\u3002</li> </ul>"},{"location":"adr/0002-robust-rate-limiter/#consequences","title":"Consequences / \u7d50\u679c","text":"<ul> <li>\u30e1\u30ea\u30c3\u30c8:<ul> <li>\u5b8c\u5168\u306a\u5b9a\u901f\u904b\u8ee2: \u30a2\u30a4\u30c9\u30eb\u5f8c\u3067\u3082\u30d0\u30fc\u30b9\u30c8\u305b\u305a\u3001\u8a2d\u5b9a\u3055\u308c\u305f\u30ec\u30fc\u30c8\uff08TPM\uff09\u3092\u53b3\u5b88\u3059\u308b\u3002</li> <li>\u30c7\u30c3\u30c9\u30ed\u30c3\u30af\u30d5\u30ea\u30fc: \u3069\u3093\u306a\u306b\u5927\u304d\u306a\u30b3\u30b9\u30c8\u306e\u30bf\u30b9\u30af\u3067\u3082\u3001\u5fc5\u8981\u306a\u5f85\u6a5f\u6642\u9593\u3092\u8a08\u7b97\u3057\u3066\u51e6\u7406\u3067\u304d\u308b\u3002</li> <li>\u5373\u6642\u8d77\u52d5: \u6700\u521d\u306e1\u56de\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306f\u5f85\u3061\u6642\u9593\u306a\u3057\u3067\u5b9f\u884c\u3055\u308c\u30012\u56de\u76ee\u4ee5\u964d\u304b\u3089\u30da\u30fc\u30b7\u30f3\u30b0\u304c\u52b9\u304f\u3002</li> <li>Fail Fast: \u8a2d\u5b9a\u5024\u3092\u8d85\u3048\u308b\u7121\u8336\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u65e9\u671f\u767a\u898b\u3067\u304d\u308b\u3002</li> </ul> </li> <li>\u30c7\u30e1\u30ea\u30c3\u30c8:<ul> <li>\u5b9f\u88c5\u304c\u300c\u30c8\u30fc\u30af\u30f3\u3092\u6d88\u8cbb\u3059\u308b\u300d\u3068\u3044\u3046\u76f4\u611f\u7684\u306a\u30e1\u30bf\u30d5\u30a1\u30fc\u304b\u3089\u5c11\u3057\u96e2\u308c\u308b\uff08\u30b3\u30fc\u30c9\u5185\u306e\u8aac\u660e\u3067\u88dc\u8db3\u3059\u308b\uff09\u3002</li> </ul> </li> </ul>"},{"location":"adr/0003-resilient-deserializeation-and-versioning/","title":"3. Resilient Deserialization and Explicit Versioning","text":""},{"location":"adr/0003-resilient-deserializeation-and-versioning/#context","title":"Context","text":"<p>Python\u306e <code>pickle</code> \u306f\u3001\u4fdd\u5b58\u3055\u308c\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u30af\u30e9\u30b9\u5b9a\u7fa9\u3068\u73fe\u5728\u306e\u30b3\u30fc\u30c9\u304c\u4e00\u81f4\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u524d\u63d0\u3068\u3059\u308b\u3002 \u958b\u767a\u4e2d\u306f\u30af\u30e9\u30b9\u5b9a\u7fa9\u304c\u983b\u7e41\u306b\u5909\u66f4\u3055\u308c\u308b\u305f\u3081\u3001\u904e\u53bb\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u8aad\u307f\u8fbc\u3080\u969b\u306b <code>AttributeError</code> \u7b49\u304c\u767a\u751f\u3057\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u30af\u30e9\u30c3\u30b7\u30e5\u3059\u308b\u554f\u984c\u304c\u3042\u3063\u305f\u3002</p>"},{"location":"adr/0003-resilient-deserializeation-and-versioning/#decision","title":"Decision","text":"<ol> <li>Fail Safe (Auto Recalc): <code>Storage.load()</code> \u3067\u30c7\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u30a8\u30e9\u30fc\uff08\u30af\u30e9\u30b9\u4e0d\u6574\u5408\u3084\u7834\u640d\uff09\u304c\u767a\u751f\u3057\u305f\u5834\u5408\u3001\u3053\u308c\u3092 <code>CacheCorruptedError</code> \u3068\u3057\u3066\u6355\u6349\u3057\u3001<code>core.py</code> \u5074\u3067 \u300c\u30ad\u30e3\u30c3\u30b7\u30e5\u30df\u30b9\u300d \u3068\u3057\u3066\u6271\u3046\u3002\u3053\u308c\u306b\u3088\u308a\u30a2\u30d7\u30ea\u3092\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u305a\u3001\u81ea\u52d5\u7684\u306b\u518d\u8a08\u7b97\u3092\u884c\u3046\u3002</li> <li>Explicit Versioning: \u30e6\u30fc\u30b6\u30fc\u304c\u610f\u56f3\u7684\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u7121\u52b9\u5316\u3067\u304d\u308b\u3088\u3046\u3001<code>@task</code> \u30c7\u30b3\u30ec\u30fc\u30bf\u306b <code>version</code> \u5f15\u6570\u3092\u8ffd\u52a0\u3059\u308b\u3002\u3053\u308c\u3092\u5909\u66f4\u3059\u308b\u3068\u30ad\u30e3\u30c3\u30b7\u30e5\u30ad\u30fc\u304c\u5909\u308f\u308a\u3001\u53e4\u3044\uff08\u4e92\u63db\u6027\u306e\u306a\u3044\uff09\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u53c2\u7167\u3057\u306a\u304f\u306a\u308b\u3002</li> <li>User Guidance: \u81ea\u52d5\u518d\u8a08\u7b97\u304c\u767a\u751f\u3057\u305f\u969b\u3001\u30ed\u30b0\u306b\u300c\u30b3\u30fc\u30c9\u5909\u66f4\u6642\u306f <code>version</code> \u306e\u66f4\u65b0\u3092\u691c\u8a0e\u3057\u3066\u306d\u300d\u3068\u3044\u3046\u30d2\u30f3\u30c8\u3092\u51fa\u529b\u3057\u3001\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u3078\u8a98\u5c0e\u3059\u308b\u3002</li> </ol>"},{"location":"adr/0003-resilient-deserializeation-and-versioning/#consequences","title":"Consequences","text":"<ul> <li>\u30e1\u30ea\u30c3\u30c8:<ul> <li>\u958b\u767a\u4e2d\u306e\u30af\u30e9\u30c3\u30b7\u30e5\u3092\u9632\u304e\u3001\u30b9\u30e0\u30fc\u30ba\u306aDX\u3092\u63d0\u4f9b\u3059\u308b\u3002</li> <li>\u672c\u756a\u904b\u7528\u6642\u3067\u3082\u3001<code>version</code> \u3092\u4f7f\u3046\u3053\u3068\u3067\u5b89\u5168\u306a\u30c7\u30d7\u30ed\u30a4\uff08\u30ad\u30e3\u30c3\u30b7\u30e5\u5207\u308a\u66ff\u3048\uff09\u304c\u53ef\u80fd\u306b\u306a\u308b\u3002</li> </ul> </li> <li>\u30c7\u30e1\u30ea\u30c3\u30c8:<ul> <li>\u518d\u8a08\u7b97\u30b3\u30b9\u30c8\u304c\u767a\u751f\u3059\u308b\uff08\u304c\u3001\u30af\u30e9\u30c3\u30b7\u30e5\u3088\u308a\u306f\u30de\u30b7\u3067\u3042\u308b\uff09\u3002</li> </ul> </li> </ul>"},{"location":"adr/0004-io-executor-lifecyle-management/","title":"Manage Executor Lifecycle via Instance Ownership and Weak References","text":""},{"location":"adr/0004-io-executor-lifecyle-management/#context-and-problem-statement","title":"Context and Problem Statement","text":"<p><code>src/beautyspot/core.py</code> \u306b\u304a\u3044\u3066\u3001\u975e\u540c\u671f\u30bf\u30b9\u30af\u306eIO\u30aa\u30d5\u30ed\u30fc\u30c9\u7528\u306b <code>ThreadPoolExecutor</code> \u304c\u30b0\u30ed\u30fc\u30d0\u30eb\u5909\u6570 <code>_io_executor</code> \u3068\u3057\u3066\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u3002</p> <p>\u3053\u306e\u5b9f\u88c5\u306b\u306f\u4ee5\u4e0b\u306e\u8ab2\u984c\u304c\u3042\u308b\uff1a</p> <ol> <li>\u30ea\u30bd\u30fc\u30b9\u5236\u5fa1\u306e\u6b20\u5982: \u30b9\u30ec\u30c3\u30c9\u6570\uff08<code>max_workers=4</code>\uff09\u304c\u30cf\u30fc\u30c9\u30b3\u30fc\u30c9\u3055\u308c\u3066\u304a\u308a\u3001\u30e6\u30fc\u30b6\u30fc\u304c\u5b9f\u884c\u74b0\u5883\uff08AWS Lambda\u3001\u5f37\u529b\u306a\u30b5\u30fc\u30d0\u30fc\u7b49\uff09\u306b\u5408\u308f\u305b\u3066\u8abf\u6574\u3067\u304d\u306a\u3044\u3002</li> <li>\u30be\u30f3\u30d3\u30d7\u30ed\u30bb\u30b9: \u30d7\u30ed\u30bb\u30b9\u7d42\u4e86\u6642\u306b\u660e\u793a\u7684\u306a\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u304c\u884c\u308f\u308c\u306a\u3044\u305f\u3081\u3001\u74b0\u5883\u306b\u3088\u3063\u3066\u306f\u30be\u30f3\u30d3\u30d7\u30ed\u30bb\u30b9\u5316\u3059\u308b\u30ea\u30b9\u30af\u304c\u3042\u308b\u3002</li> <li>\u30c6\u30b9\u30c8\u56f0\u96e3\u6027: \u30b0\u30ed\u30fc\u30d0\u30eb\u5909\u6570\u306f\u30e2\u30c3\u30af\u5316\u304c\u96e3\u3057\u304f\u3001\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u306e\u5206\u96e2\u3092\u59a8\u3052\u308b\u3002</li> </ol> <p>\u4ee3\u66ff\u6848\u3068\u3057\u3066 <code>with</code> \u6587\uff08Context Manager\uff09\u306b\u3088\u308b\u7ba1\u7406\u3082\u691c\u8a0e\u3055\u308c\u305f\u304c\u3001<code>beautyspot</code> \u306e\u300c\u30c7\u30b3\u30ec\u30fc\u30bf\u3092\u4ed8\u4e0e\u3059\u308b\u3060\u3051\u3067\u52d5\u4f5c\u3059\u308b\u300d\u3068\u3044\u3046\u7c21\u6613\u306a\u5229\u7528\u4f53\u9a13\uff08DX\uff09\u3092\u640d\u306a\u3046\u305f\u3081\u3001\u63a1\u7528\u306b\u306f\u81f3\u3089\u306a\u304b\u3063\u305f\u3002\u30e6\u30fc\u30b6\u30fc\u30b3\u30fc\u30c9\u3092\u5909\u66f4\u3055\u305b\u305a\u306b\u3001\u5b89\u5168\u306b\u30ea\u30bd\u30fc\u30b9\u3092\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u3059\u308b\u4ed5\u7d44\u307f\u304c\u5fc5\u8981\u3067\u3042\u308b\u3002</p>"},{"location":"adr/0004-io-executor-lifecyle-management/#decision-drivers","title":"Decision Drivers","text":"<ul> <li>Developer Experience (DX): \u30e6\u30fc\u30b6\u30fc\u306b <code>shutdown()</code> \u306e\u547c\u3073\u51fa\u3057\u3084 <code>with</code> \u6587\u3092\u5f37\u5236\u3057\u305f\u304f\u306a\u3044\u3002</li> <li>Configurability: \u30b9\u30ec\u30c3\u30c9\u6570\u3084 Executor \u306e\u5b9f\u88c5\u3092\u30e6\u30fc\u30b6\u30fc\u304c\u5236\u5fa1\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u305f\u3044\u3002</li> <li>Safety: \u30d7\u30ed\u30bb\u30b9\u7d42\u4e86\u6642\u3084\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u7834\u68c4\u6642\u306b\u3001\u78ba\u5b9f\u306b\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u3092\u9589\u3058\u305f\u3044\u3002</li> <li>Memory Safety: \u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u51e6\u7406\u306e\u767b\u9332\u306b\u3088\u3063\u3066\u3001\u30e1\u30e2\u30ea\u30ea\u30fc\u30af\uff08\u5faa\u74b0\u53c2\u7167\uff09\u3092\u5f15\u304d\u8d77\u3053\u3057\u3066\u306f\u306a\u3089\u306a\u3044\u3002</li> </ul>"},{"location":"adr/0004-io-executor-lifecyle-management/#considered-options","title":"Considered Options","text":"<ul> <li>Option 1: \u73fe\u72b6\u7dad\u6301\uff08\u30b0\u30ed\u30fc\u30d0\u30eb\u5909\u6570\u306e\u307e\u307e\uff09\u3002</li> <li>Option 2: <code>Project</code> \u3092 Context Manager \u5316\u3057\u3001<code>__exit__</code> \u3067 <code>shutdown()</code> \u3092\u547c\u3076\u3002</li> <li>Option 3: <code>atexit</code> \u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3044\u3001\u7d42\u4e86\u6642\u306b <code>shutdown()</code> \u3092\u547c\u3076\u3002</li> <li>Option 4: \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u7ba1\u7406\u306b\u5909\u66f4\u3057\u3001<code>weakref.finalize</code> \u3067\u81ea\u52d5\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u3092\u884c\u3046\u3002</li> </ul>"},{"location":"adr/0004-io-executor-lifecyle-management/#decision-outcome","title":"Decision Outcome","text":"<p>Chosen option: Option 4.</p> <p><code>Project</code> \u30af\u30e9\u30b9\u306e\u8a2d\u8a08\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3059\u308b\uff1a</p> <ol> <li>Executor\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5316:     \u30b0\u30ed\u30fc\u30d0\u30eb\u5909\u6570\u3092\u5ec3\u6b62\u3057\u3001<code>Project</code> \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3054\u3068\u306b <code>ThreadPoolExecutor</code> \u3092\u4fdd\u6301\u3059\u308b\u3002</li> <li>Dependency Injection (DI):     \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3067\u5916\u90e8 <code>Executor</code> \u306e\u6ce8\u5165\u3092\u8a31\u53ef\u3059\u308b\u3002</li> <li>\u6240\u6709\u6a29\u3068\u8cac\u4efb\u306e\u5206\u96e2:<ul> <li>\u5916\u90e8\u6ce8\u5165 (<code>executor</code> \u5f15\u6570\u3042\u308a): <code>Project</code> \u306f\u305d\u308c\u3092\u501f\u7528\u3059\u308b\u306e\u307f\u3002\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u306e\u8cac\u4efb\u306f\u30e6\u30fc\u30b6\u30fc\uff08\u547c\u3073\u51fa\u3057\u5143\uff09\u306b\u3042\u308b\u305f\u3081\u3001\u81ea\u52d5\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u306f\u884c\u308f\u306a\u3044\u3002</li> <li>\u5185\u90e8\u751f\u6210 (<code>executor</code> \u5f15\u6570\u306a\u3057): <code>Project</code> \u304c\u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb\u3092\u7ba1\u7406\u3059\u308b\u8cac\u4efb\u3092\u6301\u3064\u3002</li> </ul> </li> <li>\u81ea\u52d5\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7:     \u5185\u90e8\u751f\u6210\u3057\u305f\u5834\u5408\u306b\u9650\u308a\u3001<code>weakref.finalize</code> \u3092\u4f7f\u7528\u3057\u3066\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3092\u81ea\u52d5\u5316\u3059\u308b\u3002</li> </ol>"},{"location":"adr/0004-io-executor-lifecyle-management/#technical-details-why-weakreffinalize-instead-of-atexit","title":"Technical Details: Why <code>weakref.finalize</code> instead of <code>atexit</code>?","text":"<p>\u5358\u7d14\u306a <code>atexit.register(self.shutdown)</code> \u3092\u63a1\u7528\u3057\u306a\u304b\u3063\u305f\u7406\u7531\u306f\u3001\u30e1\u30e2\u30ea\u30ea\u30fc\u30af\uff08\u5faa\u74b0\u53c2\u7167\uff09\u306e\u30ea\u30b9\u30af \u3067\u3042\u308b\u3002</p> <ul> <li>\u554f\u984c\u70b9: <code>atexit</code> \u30ec\u30b8\u30b9\u30c8\u30ea\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30e1\u30bd\u30c3\u30c9\uff08<code>self.shutdown</code>\uff09\u3092\u767b\u9332\u3059\u308b\u3068\u3001<code>atexit</code> \u304c <code>self</code> \u3078\u306e\u5f37\u53c2\u7167\uff08Strong Reference\uff09\u3092\u4fdd\u6301\u3057\u7d9a\u3051\u308b\u3002\u3053\u308c\u306b\u3088\u308a\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5b9f\u884c\u4e2d\u306b <code>Project</code> \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u4e0d\u8981\u306b\u306a\u3063\u3066\u3082\u30ac\u30d9\u30fc\u30b8\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\uff08GC\uff09\u3055\u308c\u305a\u3001\u30e1\u30e2\u30ea\u30ea\u30fc\u30af\u3092\u5f15\u304d\u8d77\u3053\u3059\u3002\u3053\u308c\u3092\u9632\u3050\u306b\u306f <code>atexit.unregister</code> \u304c\u5fc5\u8981\u306b\u306a\u308b\u304c\u3001\u7ba1\u7406\u304c\u8907\u96d1\u306b\u306a\u308b\u3002</li> <li>\u89e3\u6c7a\u7b56: <code>weakref.finalize(self, func, *args)</code> \u3092\u63a1\u7528\u3059\u308b\u3002<ul> <li><code>self</code> \u304cGC\u3055\u308c\u305f\u6642\u70b9\u3067\u3001\u5373\u5ea7\u306b <code>func</code>\uff08\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u51e6\u7406\uff09\u304c\u5b9f\u884c\u3055\u308c\u308b\u3002</li> <li>\u30d7\u30ed\u30b0\u30e9\u30e0\u7d42\u4e86\u6642\u307e\u3067 <code>self</code> \u304c\u751f\u5b58\u3057\u3066\u3044\u305f\u5834\u5408\u3082\u3001<code>atexit</code> \u76f8\u5f53\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067 <code>func</code> \u304c\u5b9f\u884c\u3055\u308c\u308b\u3002</li> <li>\u91cd\u8981: \u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u95a2\u6570 <code>_shutdown_executor</code> \u306f <code>staticmethod</code> \u3068\u3057\u3001\u5f15\u6570\u306b\u306f <code>self</code> \u3067\u306f\u306a\u304f <code>self.executor</code> \u306e\u307f\u3092\u6e21\u3059\u3002\u3053\u308c\u306b\u3088\u308a\u3001\u30d5\u30a1\u30a4\u30ca\u30e9\u30a4\u30b6\u304c <code>self</code> \u3092\u53c2\u7167\u3057\u7d9a\u3051\u3066\u5bff\u547d\u3092\u5ef6\u3070\u3057\u3066\u3057\u307e\u3046\u4e8b\u6545\u3092\u9632\u3050\u3002</li> </ul> </li> </ul> <pre><code># Implementation Sketch\nclass Project:\n    def __init__(self, ...):\n        # ...\n        self.executor = ThreadPoolExecutor(...)\n        # self \u3092\u53c2\u7167\u3057\u306a\u3044\u3088\u3046\u3001executor \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3060\u3051\u3092\u6e21\u3059\n        self._finalizer = weakref.finalize(self, self._shutdown_executor, self.executor)\n\n    @staticmethod\n    def _shutdown_executor(executor):\n        executor.shutdown(wait=True)\n</code></pre>"},{"location":"adr/0004-io-executor-lifecyle-management/#consequences","title":"Consequences","text":"<ul> <li>Positive:<ul> <li>\u30e6\u30fc\u30b6\u30fc\u306f\u30ea\u30bd\u30fc\u30b9\u7ba1\u7406\u3092\u610f\u8b58\u3059\u308b\u5fc5\u8981\u304c\u306a\u304f\u306a\u308a\u3001API\u3082\u30b7\u30f3\u30d7\u30eb\u306b\u4fdd\u305f\u308c\u308b\u3002</li> <li><code>Project</code> \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304cGC\u3055\u308c\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u3082\u56de\u53ce\u3055\u308c\u308b\u305f\u3081\u3001\u30ea\u30bd\u30fc\u30b9\u52b9\u7387\u304c\u826f\u3044\u3002</li> <li>DI\u306b\u3088\u308a\u3001\u30c6\u30b9\u30c8\u6642\u306b\u30e2\u30c3\u30afExecutor\u3092\u5dee\u3057\u8fbc\u3080\u3053\u3068\u304c\u5bb9\u6613\u306b\u306a\u308b\u3002</li> </ul> </li> <li>Negative:<ul> <li><code>core.py</code> \u306e\u5b9f\u88c5\u306b\u304a\u3044\u3066\u3001GC\u306e\u6319\u52d5\u3068 <code>weakref</code> \u306e\u4ed5\u69d8\u3092\u7406\u89e3\u3057\u305f\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u304c\u5fc5\u8981\u306b\u306a\u308a\u3001\u5185\u90e8\u7684\u306a\u8907\u96d1\u6027\u304c\u82e5\u5e72\u5897\u3059\u3002</li> <li><code>Project</code> \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u5927\u91cf\u306b\u751f\u6210\u30fb\u7834\u68c4\u3059\u308b\u3088\u3046\u306a\u7279\u6b8a\u306a\u4f7f\u3044\u65b9\u3092\u3057\u305f\u5834\u5408\u3001\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u306e\u751f\u6210\u30b3\u30b9\u30c8\u304c\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u306b\u306a\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\uff08\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u30b7\u30f3\u30b0\u30eb\u30c8\u30f3\u7684\u306a\u5229\u7528\u3092\u63a8\u5968\u3059\u308b\u3053\u3068\u3067\u7de9\u548c\u3059\u308b\uff09\u3002</li> </ul> </li> </ul>"},{"location":"adr/0005-dashboard-interaction-model/","title":"ADR-002: Dashboard Interaction Model","text":""},{"location":"adr/0005-dashboard-interaction-model/#context","title":"Context","text":"<p>\u73fe\u72b6\u306e\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9 (<code>dashboard.py</code>) \u3067\u306f\u3001\u30bf\u30b9\u30af\u4e00\u89a7\u306e\u8868\u793a\u3068\u8a73\u7d30\u30c7\u30fc\u30bf\u306e\u5fa9\u5143\u64cd\u4f5c\u304c\u5206\u96e2\u3057\u3066\u3044\u308b\u3002 \u30e6\u30fc\u30b6\u30fc\u306f\u4e00\u89a7\u30c6\u30fc\u30d6\u30eb\u3067\u5bfe\u8c61\u3092\u78ba\u8a8d\u3057\u305f\u5f8c\u3001\u5225\u9014\u30c9\u30ed\u30c3\u30d7\u30c0\u30a6\u30f3\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u5bfe\u5fdc\u3059\u308b <code>cache_key</code> (\u30cf\u30c3\u30b7\u30e5\u5024) \u3092\u624b\u52d5\u3067\u63a2\u3057\u51fa\u3059\u5fc5\u8981\u304c\u3042\u308a\u3001\u8a8d\u77e5\u8ca0\u8377\u304c\u9ad8\u3044\u3002 \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u4f9d\u5b58\u95a2\u4fc2\u3068\u3057\u3066 <code>streamlit&gt;=1.51.0</code> \u304c\u78ba\u4fdd\u3055\u308c\u3066\u304a\u308a\u3001\u30a4\u30f3\u30bf\u30e9\u30af\u30c6\u30a3\u30d6\u306a\u30c7\u30fc\u30bf\u30d5\u30ec\u30fc\u30e0\u6a5f\u80fd\u304c\u5229\u7528\u53ef\u80fd\u3067\u3042\u308b\u3002</p>"},{"location":"adr/0005-dashboard-interaction-model/#decision","title":"Decision","text":"<p><code>st.dataframe</code> \u306e <code>on_select</code> \u6a5f\u80fd\u3092\u4f7f\u7528\u3057\u3001\u30c6\u30fc\u30d6\u30eb\u884c\u306e\u30af\u30ea\u30c3\u30af\u306b\u3088\u3063\u3066\u8a73\u7d30\u30d3\u30e5\u30fc\uff08Restore Data\uff09\u306e\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3092\u5207\u308a\u66ff\u3048\u308b\u65b9\u5f0f\u3092\u63a1\u7528\u3059\u308b\u3002</p>"},{"location":"adr/0005-dashboard-interaction-model/#consequences","title":"Consequences","text":"<ul> <li>Positive: \u30e6\u30fc\u30b6\u30fc\u306f\u76f4\u611f\u7684\u306b\u30ec\u30b3\u30fc\u30c9\u3092\u9078\u629e\u30fb\u5fa9\u5143\u3067\u304d\u308b\u3002</li> <li>Positive: \u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\u3055\u308c\u305f\u7d50\u679c\u306b\u5bfe\u3057\u3066\u3082\u3001\u6b63\u3057\u3044\u884c\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3067\u8a73\u7d30\u3078\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3002</li> <li>Negative: Streamlit \u306e\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\uff08&lt;1.35\uff09\u3068\u306e\u4e92\u63db\u6027\u304c\u5931\u308f\u308c\u308b\uff08\u305f\u3060\u3057 <code>pyproject.toml</code> \u3067\u30d0\u30fc\u30b8\u30e7\u30f3\u6307\u5b9a\u6e08\u307f\u306e\u305f\u3081\u8a31\u5bb9\uff09\u3002</li> </ul>"},{"location":"adr/0005-dashboard-interaction-model/#status","title":"Status","text":"<p>Proposed</p>"},{"location":"adr/0006-semantic-content-type-support/","title":"Semantic Content Type Support","text":""},{"location":"adr/0006-semantic-content-type-support/#context","title":"Context","text":"<p>\u751f\u6210AI\u30bf\u30b9\u30af\u306e\u51fa\u529b\u306f\u3001\u30c6\u30ad\u30b9\u30c8\u3060\u3051\u3067\u306a\u304f\u3001\u753b\u50cf\u3001\u69cb\u9020\u5316\u30c7\u30fc\u30bf\u3001\u30c0\u30a4\u30a2\u30b0\u30e9\u30e0\uff08Mermaid, Graphviz/DOT, HTML\uff09\u306a\u3069\u591a\u5c90\u306b\u308f\u305f\u308b\u3002 \u73fe\u72b6\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30b9\u30ad\u30fc\u30de\uff08<code>result_type</code> = <code>FILE</code> | <code>DIRECT</code>\uff09\u306f\u300c\u30c7\u30fc\u30bf\u306e\u4fdd\u5b58\u5f62\u5f0f\u300d\u3057\u304b\u4fdd\u6301\u3057\u3066\u304a\u3089\u305a\u3001\u300c\u30c7\u30fc\u30bf\u306e\u610f\u5473\u7684\u7a2e\u985e\uff08Semantic Type\uff09\u300d\u304c\u4e0d\u660e\u3067\u3042\u308b\u305f\u3081\u3001\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u3067\u306e\u5fa9\u5143\u6642\u306b\u9069\u5207\u306a\u53ef\u8996\u5316\uff08\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\uff09\u304c\u3067\u304d\u306a\u3044\u3002</p> <p>\u307e\u305f\u3001<code>beautyspot</code> \u306f\u30e9\u30a4\u30d6\u30e9\u30ea\u3068\u3057\u3066\u30e6\u30fc\u30b6\u30fc\u306e\u624b\u5143\u3067\u52d5\u4f5c\u3059\u308b\u305f\u3081\u3001\u8907\u96d1\u306a\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u624b\u9806\u3084\u91cd\u91cf\u7d1a\u306e\u4f9d\u5b58\u95a2\u4fc2\uff08Alembic\u306a\u3069\uff09\u3092\u5f37\u5236\u3059\u308b\u3053\u3068\u306fUX\u3092\u640d\u306a\u3046\u3002</p>"},{"location":"adr/0006-semantic-content-type-support/#decision","title":"Decision","text":""},{"location":"adr/0006-semantic-content-type-support/#1-database-schema-migration","title":"1. Database Schema &amp; Migration","text":"<ul> <li>Schema Change: <code>tasks</code> \u30c6\u30fc\u30d6\u30eb\u306b <code>content_type</code> (TEXT) \u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\u3059\u308b\u3002</li> <li>Migration Strategy: \"Auto-Migration on Startup\" \u3092\u63a1\u7528\u3059\u308b\u3002<ul> <li>Alembic\u7b49\u306f\u5c0e\u5165\u3057\u306a\u3044\uff08\u4f9d\u5b58\u95a2\u4fc2\u306e\u8efd\u91cf\u5316\u3068UX\u7dad\u6301\u306e\u305f\u3081\uff09\u3002</li> <li><code>Project</code> \u521d\u671f\u5316\u6642\uff08<code>_init_db</code>\uff09\u306b <code>PRAGMA table_info</code> \u3067\u30ab\u30e9\u30e0\u306e\u5b58\u5728\u3092\u78ba\u8a8d\u3057\u3001\u4e0d\u8db3\u3057\u3066\u3044\u308c\u3070\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u307f\u3067 <code>ALTER TABLE</code> \u3092\u81ea\u52d5\u5b9f\u884c\u3059\u308b\u3002</li> </ul> </li> </ul>"},{"location":"adr/0006-semantic-content-type-support/#2-type-definition","title":"2. Type Definition","text":"<ul> <li><code>src/beautyspot/types.py</code> \u3092\u65b0\u8a2d\u3057\u3001<code>ContentType</code> \u30af\u30e9\u30b9\u3067\u5b9a\u6570\u3092\u7ba1\u7406\u3059\u308b\u3002</li> <li>Graphviz (DOT) \u3068 Mermaid \u3092\u660e\u78ba\u306b\u533a\u5225\u3059\u308b\u3002<ul> <li><code>ContentType.GRAPHVIZ</code> (<code>text/vnd.graphviz</code>)</li> <li><code>ContentType.MERMAID</code> (<code>text/vnd.mermaid</code>)</li> </ul> </li> </ul>"},{"location":"adr/0006-semantic-content-type-support/#3-interface","title":"3. Interface","text":"<ul> <li><code>@project.task</code> \u30c7\u30b3\u30ec\u30fc\u30bf\u306b <code>content_type</code> \u5f15\u6570\u3092\u8ffd\u52a0\u3057\u3001\u958b\u767a\u8005\u304c\u623b\u308a\u5024\u306e\u578b\u3092\u5ba3\u8a00\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002</li> </ul>"},{"location":"adr/0006-semantic-content-type-support/#4-rendering-strategy-dashboard","title":"4. Rendering Strategy (Dashboard)","text":"<ul> <li>Graphviz: Python\u306e <code>graphviz</code> \u30e9\u30a4\u30d6\u30e9\u30ea\u3068 <code>st.graphviz_chart</code> \u3092\u4f7f\u7528\u3059\u308b\u3002</li> <li>Mermaid: Streamlit\u6a19\u6e96\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u304c\u306a\u3044\u305f\u3081\u3001<code>st.components.v1.html</code> \u3092\u4f7f\u7528\u3057\u3066 Mermaid.js (CDN) \u3092\u6ce8\u5165\u3057\u3001\u30d6\u30e9\u30a6\u30b6\u5074\u3067\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3059\u308b\u3002</li> </ul>"},{"location":"adr/0006-semantic-content-type-support/#5-dependencies","title":"5. Dependencies","text":"<ul> <li><code>pyproject.toml</code> \u306b <code>graphviz&gt;=0.20.1</code> \u3092\u8ffd\u52a0\u3059\u308b\u3002</li> </ul>"},{"location":"adr/0006-semantic-content-type-support/#consequences","title":"Consequences","text":""},{"location":"adr/0006-semantic-content-type-support/#positive","title":"Positive","text":"<ul> <li>\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u3067\u3001\u751f\u6210AI\u304c\u51fa\u529b\u3057\u305f\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u56f3\u3084\u30d5\u30ed\u30fc\u30c1\u30e3\u30fc\u30c8\u3092\u76f4\u611f\u7684\u306b\u95b2\u89a7\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u3002</li> <li>\u30e6\u30fc\u30b6\u30fc\u306f\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u4f5c\u696d\u3092\u610f\u8b58\u3059\u308b\u5fc5\u8981\u304c\u306a\u3044\uff08\u81ea\u52d5\u5316\uff09\u3002</li> <li>\u30c7\u30fc\u30bf\u306e\u300c\u4e2d\u8eab\u300d\u3092\u89e3\u6790\u3057\u3066\u8868\u793a\u5f62\u5f0f\u3092\u63a8\u6e2c\u3059\u308b\u4e0d\u5b89\u5b9a\u306a\u30ed\u30b8\u30c3\u30af\u3092\u6392\u9664\u3067\u304d\u308b\u3002</li> </ul>"},{"location":"adr/0006-semantic-content-type-support/#negative-risks","title":"Negative / Risks","text":"<ul> <li>OS\u4f9d\u5b58: Graphviz\u306e\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u306b\u306f\u3001\u30e6\u30fc\u30b6\u30fc\u74b0\u5883\u306b <code>dot</code> \u30b3\u30de\u30f3\u30c9\uff08OS\u30ec\u30d9\u30eb\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\uff09\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002</li> <li>Client-Side Rendering: Mermaid\u306fCDN\u7d4c\u7531\u306eJS\u5b9f\u884c\u3068\u306a\u308b\u305f\u3081\u3001\u30aa\u30d5\u30e9\u30a4\u30f3\u74b0\u5883\u3067\u306f\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308b\u3002</li> </ul>"},{"location":"adr/0007-customizable-serialization-with-msgpack/","title":"Customizable Serialization Strategy with Msgpack Default","text":""},{"location":"adr/0007-customizable-serialization-with-msgpack/#context-and-problem-statement","title":"Context and Problem Statement / \u30b3\u30f3\u30c6\u30ad\u30b9\u30c8","text":"<p>\u73fe\u5728\u3001<code>beautyspot</code> \u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u30c7\u30fc\u30bf\u306e\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\uff08\u4fdd\u5b58\uff09\u306b Python \u6a19\u6e96\u306e <code>pickle</code> \u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u3002 \u3053\u308c\u306b\u306f\u4ee5\u4e0b\u306e\u91cd\u5927\u306a\u8ab2\u984c\u304c\u3042\u308b\uff1a</p> <ol> <li>\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30ea\u30b9\u30af (RCE): <code>pickle</code> \u306f\u4fe1\u983c\u3067\u304d\u306a\u3044\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u8fbc\u3080\u969b\u306b\u4efb\u610f\u306e\u30b3\u30fc\u30c9\u5b9f\u884c\uff08RCE\uff09\u3092\u5f15\u304d\u8d77\u3053\u3059\u53ef\u80fd\u6027\u304c\u3042\u308a\u3001\u300c\u5171\u6709\u30ad\u30e3\u30c3\u30b7\u30e5\u300d\u3068\u3057\u3066\u306e\u5229\u7528\u306b\u30ea\u30b9\u30af\u304c\u3042\u308b\u3002</li> <li>\u4e92\u63db\u6027: Python \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3084\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u5909\u308f\u308b\u3068\u3001\u30af\u30e9\u30b9\u5b9a\u7fa9\u306e\u4e0d\u6574\u5408\u306b\u3088\u308a\u30c7\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u306b\u5931\u6557\u3057\u3084\u3059\u3044\u3002</li> <li>\u4ee3\u66ff\u6848\u306e\u6b20\u70b9: \u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u306e <code>json</code> \u306f\u5b89\u5168\u3060\u304c\u3001\u753b\u50cf\u306a\u3069\u306e\u30d0\u30a4\u30ca\u30ea\u30c7\u30fc\u30bf\u3092\u52b9\u7387\u7684\u306b\u6271\u3048\u305a\uff08Base64\u5316\u3067\u30b5\u30a4\u30ba\u5897\uff09\u3001\u30bf\u30d7\u30eb\u306a\u3069\u306ePython\u56fa\u6709\u578b\u304c\u5931\u308f\u308c\u308b\u3002</li> </ol> <p>v1.0.0 \u30ea\u30ea\u30fc\u30b9\u306b\u3042\u305f\u308a\u3001\u300c\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u5b89\u5168\uff08Secure by Default\uff09\u300d \u304b\u3064 \u300c\u62e1\u5f35\u6027\uff08Extensibility\uff09\u300d \u306e\u3042\u308b\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u6226\u7565\u304c\u5fc5\u8981\u3067\u3042\u308b\u3002</p>"},{"location":"adr/0007-customizable-serialization-with-msgpack/#decision-drivers","title":"Decision Drivers / \u8981\u6c42","text":"<ul> <li>Security: \u30c7\u30d5\u30a9\u30eb\u30c8\u72b6\u614b\u3067 RCE \u306e\u30ea\u30b9\u30af\u3092\u6392\u9664\u3057\u305f\u3044\u3002</li> <li>Performance: \u753b\u50cf\u3084Numpy\u914d\u5217\u306a\u3069\u306e\u30d0\u30a4\u30ca\u30ea\u30c7\u30fc\u30bf\u3092\u3001\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u306a\u304f\u9ad8\u901f\u306b\u6271\u3044\u305f\u3044\u3002</li> <li>Extensibility: \u30e6\u30fc\u30b6\u30fc\u304c\u72ec\u81ea\u306e\u30af\u30e9\u30b9\u3084\u7279\u6b8a\u306a\u578b\uff08\u4f8b: <code>pandas.DataFrame</code>\uff09\u3092\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u5074\u306e\u5909\u66f4\u306a\u3057\u306b\u4fdd\u5b58\u30fb\u5fa9\u5143\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u305f\u3044\u3002</li> <li>Developer Experience (DX): \u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u5931\u6557\u6642\u306b\u3001\u300c\u3069\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u539f\u56e0\u304b\u300d\u3068\u300c\u3069\u3046\u3059\u308c\u3070\u89e3\u6c7a\u3067\u304d\u308b\u304b\u300d\u3092\u660e\u78ba\u306b\u793a\u3057\u305f\u3044\u3002</li> </ul>"},{"location":"adr/0007-customizable-serialization-with-msgpack/#considered-options","title":"Considered Options / \u691c\u8a0e","text":"<ul> <li>Option 1: \u73fe\u72b6\u7dad\u6301\uff08<code>pickle</code> \u306e\u307e\u307e\uff09\u3002\u8b66\u544a\u6587\u3067\u8cac\u4efb\u3092\u30e6\u30fc\u30b6\u30fc\u306b\u59d4\u306d\u308b\u3002</li> <li>Option 2: \u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea <code>json</code> \u306b\u4e00\u672c\u5316\u3059\u308b\u3002\u30d0\u30a4\u30ca\u30ea\u306f Base64 \u30a8\u30f3\u30b3\u30fc\u30c9\u3092\u5f37\u5236\u3059\u308b\u3002</li> <li>Option 3: <code>msgpack</code> \u3092\u63a1\u7528\u3057\u3001\u6a19\u6e96\u578b\u306e\u307f\u30b5\u30dd\u30fc\u30c8\u3059\u308b\u3002</li> <li>Option 4: <code>msgpack</code> \u3092\u63a1\u7528\u3057\u3001<code>ExtType</code> \u6a5f\u80fd\u3092\u7528\u3044\u305f\u300c\u30ab\u30b9\u30bf\u30e0\u578b\u767b\u9332\u30b7\u30b9\u30c6\u30e0\u300d\u3092\u5b9f\u88c5\u3059\u308b\u3002</li> </ul>"},{"location":"adr/0007-customizable-serialization-with-msgpack/#decision-outcome","title":"Decision Outcome / \u6c7a\u5b9a","text":"<p>Chosen option: Option 4.</p> <p>\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3068\u3057\u3066 <code>msgpack</code> (MessagePack) \u3092\u63a1\u7528\u3057\u3001\u3055\u3089\u306b\u30e6\u30fc\u30b6\u30fc\u304c\u4efb\u610f\u306e\u578b\u5909\u63db\u30ed\u30b8\u30c3\u30af\u3092\u6ce8\u5165\u3067\u304d\u308b <code>TypeRegistry</code> \u30d1\u30bf\u30fc\u30f3\u3092\u5c0e\u5165\u3059\u308b\u3002</p> <ol> <li>\u4f9d\u5b58\u95a2\u4fc2: <code>msgpack&gt;=1.0.0</code> \u3092 <code>pyproject.toml</code> \u306b\u8ffd\u52a0\u3059\u308b\u3002</li> <li>\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u6319\u52d5:<ul> <li><code>pickle</code> \u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u304b\u3089\u5ec3\u6b62\uff08\u307e\u305f\u306f\u30aa\u30d7\u30c8\u30a4\u30f3\u5316\uff09\u3059\u308b\u3002</li> <li><code>msgpack</code> \u3092\u4f7f\u7528\u3057\u3001\u5b89\u5168\u306a\u578b\u306e\u307f\u3092\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3059\u308b\u3002</li> </ul> </li> <li>\u30ab\u30b9\u30bf\u30e0\u578b\u306e\u767b\u9332:<ul> <li><code>Project</code> \u30af\u30e9\u30b9\u306b <code>register_type(type, code, encoder, decoder)</code> \u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\u3059\u308b\u3002</li> <li>\u30e6\u30fc\u30b6\u30fc\u306f\u3001\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3067\u304d\u306a\u3044\u578b\uff08\u4f8b: \u30ab\u30b9\u30bf\u30e0\u30af\u30e9\u30b9\uff09\u306b\u5bfe\u3057\u3066\u3001\u4e00\u610f\u306aID (<code>code</code>) \u3068\u5909\u63db\u95a2\u6570\u3092\u767b\u9332\u3059\u308b\u3053\u3068\u3067\u5bfe\u5fdc\u3067\u304d\u308b\u3002</li> </ul> </li> <li>\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0:<ul> <li>\u672a\u767b\u9332\u306e\u578b\u306b\u906d\u9047\u3057\u305f\u5834\u5408\u3001\u6a19\u6e96\u306e <code>TypeError</code> \u3067\u306f\u306a\u304f\u3001\u5177\u4f53\u7684\u306a\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u60c5\u5831\u3068 <code>register_type</code> \u306e\u5229\u7528\u3092\u4fc3\u3059\u89aa\u5207\u306a\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8 (<code>SerializationError</code>) \u3092\u9001\u51fa\u3059\u308b\u3002</li> </ul> </li> </ol>"},{"location":"adr/0007-customizable-serialization-with-msgpack/#technical-details","title":"Technical Details / \u6280\u8853\u8a73\u7d30","text":"<p><code>msgpack</code> \u306e <code>default</code> (pack\u6642) \u3068 <code>ext_hook</code> (unpack\u6642) \u3092\u6d3b\u7528\u3057\u3001\u62e1\u5f35\u578b\u3092 <code>msgpack.ExtType</code> \u3068\u3057\u3066\u30e9\u30c3\u30d7\u3059\u308b\u3002</p> <pre><code># Implementation Sketch\n\nclass Project:\n    def __init__(self, ...):\n        # ...\n        self.serializer = MsgpackSerializer()\n\n    def register_type(self, type_: type, code: int, encoder: Callable, decoder: Callable):\n        \"\"\"\n        Register a custom serializer for a specific type.\n\n        Args:\n            type_: The class to handle (e.g. MyClass)\n            code: Unique integer ID (0-127) for this type\n            encoder: Function that converts obj -&gt; bytes\n            decoder: Function that converts bytes -&gt; obj\n        \"\"\"\n        self.serializer.register(type_, code, encoder, decoder)\n\n# --- Internal ---\n\nclass MsgpackSerializer:\n    def dump(self, obj):\n        return msgpack.packb(obj, default=self._default_packer, use_bin_type=True)\n\n    def load(self, data):\n        return msgpack.unpackb(data, ext_hook=self._ext_hook, raw=False)\n\n    def _default_packer(self, obj):\n        # \u767b\u9332\u6e08\u307f\u306e\u578b\u306a\u3089 ExtType \u306b\u5909\u63db\n        if type(obj) in self._encoders:\n            code, encoder = self._encoders[type(obj)]\n            return msgpack.ExtType(code, encoder(obj))\n\n        # \u672a\u767b\u9332\u306a\u3089\u8a73\u7d30\u306a\u30a8\u30e9\u30fc\u3092\u51fa\u3059\n        raise SerializationError(f\"Object of type '{type(obj).__name__}' is not serializable...\")\n</code></pre>"},{"location":"adr/0007-customizable-serialization-with-msgpack/#consequences","title":"Consequences / \u7d50\u679c","text":"<ul> <li>Positive:<ul> <li>\u5b89\u5168\u6027: <code>pickle</code> \u3092\u6392\u9664\u3059\u308b\u3053\u3068\u3067\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306e\u8106\u5f31\u6027\u3092\u89e3\u6d88\u3067\u304d\u308b\u3002</li> <li>\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9: <code>json</code> + Base64 \u3088\u308a\u3082\u9ad8\u901f\u304b\u3064\u7701\u30b5\u30a4\u30ba\u3067\u30d0\u30a4\u30ca\u30ea\u30c7\u30fc\u30bf\u3092\u6271\u3048\u308b\u3002</li> <li>\u67d4\u8edf\u6027: \u30e6\u30fc\u30b6\u30fc\u306f\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u30d5\u30a9\u30fc\u30af\u3059\u308b\u3053\u3068\u306a\u304f\u3001\u5fc5\u8981\u306a\u578b\uff08Numpy, Pandas, Custom Class\uff09\u306e\u5bfe\u5fdc\u3092\u8ffd\u52a0\u3067\u304d\u308b\u3002</li> </ul> </li> <li>Negative:<ul> <li>\u4f9d\u5b58\u95a2\u4fc2: \u65b0\u305f\u306b <code>msgpack</code> \u30d1\u30c3\u30b1\u30fc\u30b8\u3078\u306e\u4f9d\u5b58\u304c\u767a\u751f\u3059\u308b\uff08\u305f\u3060\u3057\u8efd\u91cf\u3067\u3042\u308b\u305f\u3081\u8a31\u5bb9\u7bc4\u56f2\u3068\u3059\u308b\uff09\u3002</li> <li>\u79fb\u884c\u30b3\u30b9\u30c8: \u65e2\u5b58\u306e <code>pickle</code> \u3067\u4fdd\u5b58\u3055\u308c\u305f\u30ad\u30e3\u30c3\u30b7\u30e5\u30c7\u30fc\u30bf (<code>.pkl</code>) \u3068\u306e\u4e92\u63db\u6027\u304c\u306a\u304f\u306a\u308b\u305f\u3081\u3001v1.0.0 \u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u6642\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\uff08DB\u30ea\u30bb\u30c3\u30c8\uff09\u304c\u5fc5\u8981\u306b\u306a\u308b\u3002</li> </ul> </li> </ul>"},{"location":"adr/0008-database-dependency-injection/","title":"Database Dependency Injection and Abstraction","text":""},{"location":"adr/0008-database-dependency-injection/#context-and-problem-statement","title":"Context and Problem Statement / \u30b3\u30f3\u30c6\u30ad\u30b9\u30c8","text":"<p>\u3053\u308c\u307e\u3067\u306e <code>beautyspot</code> (<code>v0.x</code>) \u306f\u3001<code>Project</code> \u30af\u30e9\u30b9\u5185\u90e8\u3067 <code>TaskDB</code> (SQLite\u5b9f\u88c5) \u3092\u30cf\u30fc\u30c9\u30b3\u30fc\u30c9\u3057\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5316\u3057\u3066\u3044\u305f\u3002</p> <pre><code># v0.x implementation\nself.db = TaskDB(self.db_path)\n</code></pre> <p>\u3053\u306e\u8a2d\u8a08\u306b\u306f\u4ee5\u4e0b\u306e\u8ab2\u984c\u304c\u3042\u308b\uff1a</p> <ol> <li>\u62e1\u5f35\u6027\u306e\u6b20\u5982: SQLite \u4ee5\u5916\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\uff08PostgreSQL, DuckDB, In-Memory DB\u7b49\uff09\u3092\u4f7f\u3044\u305f\u304f\u3066\u3082\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u304d\u63db\u3048\u306a\u3044\u9650\u308a\u4e0d\u53ef\u80fd\u3067\u3042\u308b\u3002</li> <li>\u30c6\u30b9\u30c8\u306e\u5236\u7d04: \u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u6642\u306b\u3001\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306b\u4f9d\u5b58\u3057\u306a\u3044\u30e2\u30c3\u30afDB\u3084\u30aa\u30f3\u30e1\u30e2\u30eaDB\u3078\u306e\u5dee\u3057\u66ff\u3048\u304c\u56f0\u96e3\u3067\u3042\u308b\u3002</li> </ol> <p>v1.0.0 \u3067\u306f\u3001\u30e6\u30fc\u30b6\u30fc\u4f53\u9a13\uff08DX\uff09\u3068\u3057\u3066\u306e\u300c\u624b\u8efd\u3055\uff08\u30d1\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3060\u3051\uff09\u300d\u3092\u7dad\u6301\u3057\u3064\u3064\u3001\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u30ec\u30d9\u30eb\u3067\u306e\u67d4\u8edf\u6027\u3092\u78ba\u4fdd\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002</p>"},{"location":"adr/0008-database-dependency-injection/#decision-drivers","title":"Decision Drivers / \u8981\u6c42","text":"<ul> <li>Extensibility: \u30e6\u30fc\u30b6\u30fc\u304c\u72ec\u81ea\u306e <code>TaskDB</code> \u5b9f\u88c5\u3092\u6ce8\u5165 (Inject) \u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002</li> <li>Backward Compatibility / DX: \u5f93\u6765\u901a\u308a\u30d5\u30a1\u30a4\u30eb\u30d1\u30b9\uff08\u6587\u5b57\u5217\uff09\u3092\u6e21\u3059\u3060\u3051\u306e\u521d\u671f\u5316\u3082\u30b5\u30dd\u30fc\u30c8\u3057\u3001\u30e9\u30a4\u30c8\u30e6\u30fc\u30b6\u30fc\u306e\u8ca0\u62c5\u3092\u5897\u3084\u3055\u306a\u3044\u3002</li> <li>Testability: \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u5c64\u306e\u30e2\u30c3\u30af\u5316\u3092\u5bb9\u6613\u306b\u3059\u308b\u3002</li> </ul>"},{"location":"adr/0008-database-dependency-injection/#decision-outcome","title":"Decision Outcome / \u6c7a\u5b9a","text":"<p>Chosen option: Dependency Injection with Abstract Base Class.</p> <ol> <li>\u62bd\u8c61\u5316: <code>src/beautyspot/db.py</code> \u306b\u62bd\u8c61\u57fa\u5e95\u30af\u30e9\u30b9 <code>TaskDB</code> \u3092\u5b9a\u7fa9\u3057\u3001\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\uff08<code>save</code>, <code>get</code>, <code>init_schema</code> \u7b49\uff09\u3092\u5f37\u5236\u3059\u308b\u3002</li> <li>\u5177\u8c61\u5316: \u5f93\u6765\u306eSQLite\u5b9f\u88c5\u3092 <code>SQLiteTaskDB</code> \u3068\u3057\u3066\u518d\u5b9a\u7fa9\u3059\u308b\u3002</li> <li>\u6ce8\u5165 (DI): <code>Project</code> \u30af\u30e9\u30b9\u306e\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u5f15\u6570\u3092 <code>db_path: str</code> \u304b\u3089 <code>db: Union[str, TaskDB]</code> \u306b\u5909\u66f4\u3059\u308b\u3002<ul> <li><code>str</code> \u304c\u6e21\u3055\u308c\u305f\u5834\u5408: \u5185\u90e8\u3067 <code>SQLiteTaskDB(path)</code> \u3092\u751f\u6210\u3059\u308b\uff08Convenience\uff09\u3002</li> <li><code>TaskDB</code> \u304c\u6e21\u3055\u308c\u305f\u5834\u5408: \u305d\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u305d\u306e\u307e\u307e\u4f7f\u7528\u3059\u308b\uff08Injection\uff09\u3002</li> </ul> </li> </ol>"},{"location":"adr/0008-database-dependency-injection/#consequences","title":"Consequences / \u7d50\u679c","text":"<ul> <li>Positive:<ul> <li>PostgreSQL \u3084 MySQL \u306a\u3069\u306e\u30a2\u30c0\u30d7\u30bf\u3092\u30e6\u30fc\u30b6\u30fc\u5074\u3067\u5b9f\u88c5\u3057\u3001<code>Project(..., db=PostgresDB(...))</code> \u306e\u3088\u3046\u306b\u5229\u7528\u53ef\u80fd\u306b\u306a\u308b\u3002</li> <li>\u30c6\u30b9\u30c8\u6642\u306b <code>MemoryTaskDB</code> \u306a\u3069\u3092\u5dee\u3057\u8fbc\u3080\u3053\u3068\u3067\u3001\u9ad8\u901f\u304b\u3064\u30af\u30ea\u30fc\u30f3\u306a\u30c6\u30b9\u30c8\u304c\u53ef\u80fd\u306b\u306a\u308b\u3002</li> </ul> </li> <li>Negative:<ul> <li><code>db_path</code> \u5f15\u6570\u304c\u5ec3\u6b62\uff08\u307e\u305f\u306f <code>db</code> \u306b\u7d71\u5408\uff09\u3055\u308c\u308b\u305f\u3081\u3001\u65e2\u5b58\u30b3\u30fc\u30c9\u306e\u5f15\u6570\u540d\u5909\u66f4\u304c\u5fc5\u8981\u306b\u306a\u308b\uff08v1.0.0 \u3067\u306e\u7834\u58ca\u7684\u5909\u66f4\uff09\u3002</li> </ul> </li> </ul>"},{"location":"advanced/custom_backend/","title":"\ud83d\udee0\ufe0f Custom Database Backend Guide","text":"<p><code>beautyspot</code> \u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067 SQLite \u3092\u4f7f\u7528\u3057\u307e\u3059\u304c\u3001\u5927\u898f\u6a21\u306a\u5206\u6563\u51e6\u7406\u3084\u3001\u30af\u30e9\u30a6\u30c9\u30cd\u30a4\u30c6\u30a3\u30d6\u306a\u74b0\u5883\uff08Kubernetes\u306a\u3069\uff09\u3067\u52d5\u4f5c\u3055\u305b\u308b\u5834\u5408\u3001PostgreSQL \u3084 MySQL\u3001\u3042\u308b\u3044\u306f DynamoDB \u3068\u3044\u3063\u305f\u5916\u90e8\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u5229\u7528\u3057\u305f\u304f\u306a\u308b\u3067\u3057\u3087\u3046\u3002</p> <p>v1.0.0 \u304b\u3089\u5c0e\u5165\u3055\u308c\u305f Dependency Injection (DI) \u6a5f\u69cb\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u3067\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30b3\u30fc\u30c9\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u306a\u304f\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u81ea\u7531\u306b\u5dee\u3057\u66ff\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002</p>"},{"location":"advanced/custom_backend/#1-the-interface-taskdb","title":"1. The Interface: <code>TaskDB</code>","text":"<p>\u30ab\u30b9\u30bf\u30e0\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u4f5c\u6210\u3059\u308b\u306b\u306f\u3001<code>beautyspot.db.TaskDB</code> \u62bd\u8c61\u57fa\u5e95\u30af\u30e9\u30b9\uff08Abstract Base Class\uff09\u3092\u7d99\u627f\u3057\u3001\u4ee5\u4e0b\u306e4\u3064\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002</p> <p>               Bases: <code>ABC</code></p> <p>Abstract interface for task metadata storage. Implement this class to support other databases (e.g., PostgreSQL, DuckDB).</p> Source code in <code>src/beautyspot/db.py</code> <pre><code>class TaskDB(ABC):\n    \"\"\"\n    Abstract interface for task metadata storage.\n    Implement this class to support other databases (e.g., PostgreSQL, DuckDB).\n    \"\"\"\n    @abstractmethod\n    def init_schema(self):\n        \"\"\"Initialize database schema (create tables, migrations).\"\"\"\n        pass\n\n    @abstractmethod\n    def get(self, cache_key: str) -&gt; Optional[Dict[str, Any]]:\n        \"\"\"Retrieve a task result by cache key.\"\"\"\n        pass\n\n    @abstractmethod\n    def save(\n        self, \n        cache_key: str, \n        func_name: str, \n        input_id: str, \n        version: Optional[str], \n        result_type: str, \n        content_type: Optional[str], \n        result_value: str\n    ):\n        \"\"\"Upsert a task result.\"\"\"\n        pass\n\n    @abstractmethod\n    def get_history(self, limit: int = 1000) -&gt; \"pd.DataFrame\":\n        \"\"\"Fetch task history for analysis/dashboard.\"\"\"\n        pass\n</code></pre>"},{"location":"advanced/custom_backend/#beautyspot.db.TaskDB.get","title":"<code>get(cache_key)</code>  <code>abstractmethod</code>","text":"<p>Retrieve a task result by cache key.</p> Source code in <code>src/beautyspot/db.py</code> <pre><code>@abstractmethod\ndef get(self, cache_key: str) -&gt; Optional[Dict[str, Any]]:\n    \"\"\"Retrieve a task result by cache key.\"\"\"\n    pass\n</code></pre>"},{"location":"advanced/custom_backend/#beautyspot.db.TaskDB.get_history","title":"<code>get_history(limit=1000)</code>  <code>abstractmethod</code>","text":"<p>Fetch task history for analysis/dashboard.</p> Source code in <code>src/beautyspot/db.py</code> <pre><code>@abstractmethod\ndef get_history(self, limit: int = 1000) -&gt; \"pd.DataFrame\":\n    \"\"\"Fetch task history for analysis/dashboard.\"\"\"\n    pass\n</code></pre>"},{"location":"advanced/custom_backend/#beautyspot.db.TaskDB.init_schema","title":"<code>init_schema()</code>  <code>abstractmethod</code>","text":"<p>Initialize database schema (create tables, migrations).</p> Source code in <code>src/beautyspot/db.py</code> <pre><code>@abstractmethod\ndef init_schema(self):\n    \"\"\"Initialize database schema (create tables, migrations).\"\"\"\n    pass\n</code></pre>"},{"location":"advanced/custom_backend/#beautyspot.db.TaskDB.save","title":"<code>save(cache_key, func_name, input_id, version, result_type, content_type, result_value)</code>  <code>abstractmethod</code>","text":"<p>Upsert a task result.</p> Source code in <code>src/beautyspot/db.py</code> <pre><code>@abstractmethod\ndef save(\n    self, \n    cache_key: str, \n    func_name: str, \n    input_id: str, \n    version: Optional[str], \n    result_type: str, \n    content_type: Optional[str], \n    result_value: str\n):\n    \"\"\"Upsert a task result.\"\"\"\n    pass\n</code></pre>"},{"location":"advanced/custom_backend/#contract","title":"\u5b9f\u88c5\u306e\u8981\u4ef6 (Contract)","text":"<ul> <li>Thread Safety: <code>Project</code> \u306f\u30de\u30eb\u30c1\u30b9\u30ec\u30c3\u30c9\u3067\u52d5\u4f5c\u3059\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30a2\u30c0\u30d7\u30bf\u306f\u30b9\u30ec\u30c3\u30c9\u30bb\u30fc\u30d5\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002</li> <li>Schema Initialization: <code>init_schema()</code> \u306f <code>Project</code> \u521d\u671f\u5316\u6642\u306b\u6bce\u56de\u547c\u3070\u308c\u307e\u3059\u3002\u300c\u30c6\u30fc\u30d6\u30eb\u304c\u306a\u3051\u308c\u3070\u4f5c\u6210\u3059\u308b\uff08IF NOT EXISTS\uff09\u300d\u3088\u3046\u306b\u5b9f\u88c5\u3057\u3066\u304f\u3060\u3055\u3044\u3002</li> <li>Idempotency: <code>save()</code> \u306f\u540c\u3058\u30ad\u30fc\u3067\u4f55\u5ea6\u3082\u547c\u3070\u308c\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002<code>INSERT OR REPLACE</code> (Upsert) \u306e\u6319\u52d5\u3092\u5b9f\u88c5\u3057\u3066\u304f\u3060\u3055\u3044\u3002</li> </ul>"},{"location":"advanced/custom_backend/#2-implementation-example","title":"2. Implementation Example","text":"<p>\u3053\u3053\u3067\u306f\u4f8b\u3068\u3057\u3066\u3001\u958b\u767a\u3084\u30c6\u30b9\u30c8\u306b\u4fbf\u5229\u306a\u300c\u30a4\u30f3\u30e1\u30e2\u30ea\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\uff08\u8f9e\u66f8\u30d9\u30fc\u30b9\uff09\u300d\u306e\u5b9f\u88c5\u3092\u793a\u3057\u307e\u3059\u3002 \u672c\u756a\u74b0\u5883\u3067 PostgreSQL \u7b49\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u3082\u3001\u57fa\u672c\u7684\u306a\u69cb\u9020\u306f\u540c\u3058\u3067\u3059\u3002</p> <pre><code>from typing import Any, Dict, Optional\nimport pandas as pd\nfrom beautyspot.db import TaskDB\n\nclass MemoryTaskDB(TaskDB):\n    \"\"\"\n    \u30aa\u30f3\u30e1\u30e2\u30ea\u3067\u52d5\u4f5c\u3059\u308b\u63ee\u767a\u6027\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3002\n    \u30c6\u30b9\u30c8\u3084\u3001\u6c38\u7d9a\u5316\u304c\u4e0d\u8981\u306a\u4e00\u6642\u7684\u306a\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u6700\u9069\u3067\u3059\u3002\n    \"\"\"\n    def __init__(self):\n        self._storage: Dict[str, Dict[str, Any]] = {}\n\n    def init_schema(self):\n        # \u30e1\u30e2\u30ea\u4e0a\u306e\u8f9e\u66f8\u306a\u306e\u3067\u30b9\u30ad\u30fc\u30de\u4f5c\u6210\u306f\u4e0d\u8981\n        pass\n\n    def get(self, cache_key: str) -&gt; Optional[Dict[str, Any]]:\n        return self._storage.get(cache_key)\n\n    def save(\n        self, \n        cache_key: str, \n        func_name: str, \n        input_id: str, \n        version: Optional[str], \n        result_type: str, \n        content_type: Optional[str], \n        result_value: str\n    ):\n        # \u8f9e\u66f8\u306b\u4fdd\u5b58\uff08Upsert\uff09\n        self._storage[cache_key] = {\n            \"func_name\": func_name,\n            \"input_id\": input_id,\n            \"version\": version,\n            \"result_type\": result_type,\n            \"content_type\": content_type,\n            \"result_value\": result_value,\n            \"updated_at\": pd.Timestamp.now() # \u5c65\u6b74\u7528\n        }\n\n    def get_history(self, limit: int = 1000) -&gt; pd.DataFrame:\n        if not self._storage:\n            return pd.DataFrame()\n\n        # \u8f9e\u66f8\u304b\u3089DataFrame\u3092\u4f5c\u6210\n        df = pd.DataFrame(list(self._storage.values()))\n        df[\"cache_key\"] = list(self._storage.keys())\n        return df.sort_values(\"updated_at\", ascending=False).head(limit)\n</code></pre>"},{"location":"advanced/custom_backend/#3-injection-how-to-use","title":"3. Injection (How to use)","text":"<p>\u4f5c\u6210\u3057\u305f\u30ab\u30b9\u30bf\u30e0\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u3001<code>Project</code> \u306e <code>db</code> \u5f15\u6570\u306b\u6e21\u3059\u3060\u3051\u3067\u3059\u3002</p> <pre><code>import beautyspot as bs\n\n# 1. \u30ab\u30b9\u30bf\u30e0DB\u3092\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5316\nmy_memory_db = MemoryTaskDB()\n\n# 2. Project\u306b\u6ce8\u5165 (\u30d1\u30b9\u6587\u5b57\u5217\u3067\u306f\u306a\u304f\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6e21\u3059)\nproject = bs.Project(\"memory_app\", db=my_memory_db)\n\n@project.task\ndef calc(x):\n    return x * 2\n\n# \u3053\u306e\u7d50\u679c\u306f SQLite \u30d5\u30a1\u30a4\u30eb\u3067\u306f\u306a\u304f\u3001\u30e1\u30e2\u30ea\u4e0a\u306b\u4fdd\u5b58\u3055\u308c\u307e\u3059\nprint(calc(10)) \n</code></pre>"},{"location":"advanced/custom_backend/#4-advanced-using-postgresql-mysql","title":"4. Advanced: Using PostgreSQL / MySQL","text":"<p>RDBMS \u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001<code>sqlalchemy</code> \u3084 <code>psycopg2</code> \u3092\u4f7f\u7528\u3057\u3066 <code>TaskDB</code> \u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002 <code>src/beautyspot/db.py</code> \u5185\u306e <code>SQLiteTaskDB</code> \u306e\u5b9f\u88c5\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002</p> <p>\u7279\u306b\u4ee5\u4e0b\u306e\u70b9\u306b\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\uff1a</p> <ul> <li>\u63a5\u7d9a\u7ba1\u7406: <code>save</code> \u3084 <code>get</code> \u306e\u305f\u3073\u306b\u63a5\u7d9a\u3092\u958b\u304f\u304b\u3001\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u3092\u4f7f\u7528\u3059\u308b\u304b\u3092\u9069\u5207\u306b\u8a2d\u8a08\u3057\u3066\u304f\u3060\u3055\u3044\u3002</li> <li>JSON\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba: <code>beautyspot</code> \u306f\u7d50\u679c\u3092 JSON \u6587\u5b57\u5217\u3068\u3057\u3066\u6e21\u3057\u307e\u3059\u3002DB\u5074\u306b\u306f <code>TEXT</code> \u578b\u307e\u305f\u306f <code>JSONB</code> \u578b\u306e\u30ab\u30e9\u30e0\u3092\u7528\u610f\u3057\u3066\u304f\u3060\u3055\u3044\u3002</li> </ul>"},{"location":"reference/architecture/","title":"Architecture","text":""},{"location":"reference/architecture/#architecturemd","title":"\ud83d\udcc4 ARCHITECTURE.md","text":""},{"location":"reference/architecture/#architecture-design","title":"Architecture &amp; Design","text":""},{"location":"reference/architecture/#architecture-design-overview","title":"\ud83c\udfd7\ufe0f Architecture &amp; Design Overview","text":"<p><code>beautyspot</code> \u306f\u3001\u95a2\u6570\u30c7\u30b3\u30ec\u30fc\u30bf\u3092\u901a\u3058\u3066\u300c\u5b9f\u884c\u5236\u5fa1\uff08Caching, Rate Limiting, Persistence\uff09\u300d\u3092\u65e2\u5b58\u306e\u30ed\u30b8\u30c3\u30af\u306b\u6ce8\u5165\u3059\u308b\u3001\u975e\u4fb5\u5165\u578b\uff08Non-intrusive\uff09 \u306e\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u30e9\u30a4\u30d6\u30e9\u30ea\u3067\u3059\u3002</p>"},{"location":"reference/architecture/#1-core-philosophy-the-kuroko-pattern","title":"1. Core Philosophy: \"The Kuroko (\u9ed2\u5b50) Pattern\"","text":"<p>\u30e6\u30fc\u30b6\u30fc\u306e\u30d3\u30b8\u30cd\u30b9\u30ed\u30b8\u30c3\u30af\uff08\u95a2\u6570\uff09\u3092\u6c5a\u67d3\u305b\u305a\u3001\u30a4\u30f3\u30d5\u30e9\u30b9\u30c8\u30e9\u30af\u30c1\u30e3\u306e\u8907\u96d1\u6027\u3092\u96a0\u853d\u3059\u308b\u3053\u3068\u3092\u8a2d\u8a08\u306e\u4e3b\u773c\u3068\u3057\u3066\u3044\u307e\u3059\u3002</p> <ul> <li>No Inheritance: \u30e6\u30fc\u30b6\u30fc\u306f\u7279\u5b9a\u306e\u30af\u30e9\u30b9\u3092\u7d99\u627f\u3059\u308b\u5fc5\u8981\u304c\u306a\u3044\u3002</li> <li>No Global State: <code>Project</code> \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3054\u3068\u306b\u72ec\u7acb\u3057\u305f\u72b6\u614b\uff08DB, TokenBucket\uff09\u3092\u6301\u3064\u3002</li> <li>Fail-Safe: \u30e9\u30a4\u30d6\u30e9\u30ea\u5185\u90e8\u306e\u6574\u5408\u6027\u30a8\u30e9\u30fc\u304c\u3001\u30e6\u30fc\u30b6\u30fc\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u3066\u306f\u306a\u3089\u306a\u3044\u3002</li> </ul>"},{"location":"reference/architecture/#2-system-components-code-mapping","title":"2. System Components &amp; Code Mapping","text":"<p>\u5404\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u304c\u3001\u30b3\u30fc\u30c9\u30d9\u30fc\u30b9\u4e0a\u306e\u3069\u306e\u30af\u30e9\u30b9\u30fb\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u5bfe\u5fdc\u3059\u308b\u304b\u3092\u660e\u8a18\u3057\u305f\u30b7\u30b9\u30c6\u30e0\u56f3\u3067\u3059\u3002</p> <pre><code>graph TD\n    UserFunc[User Function] --&gt;|Decorated by| TaskWrapper\n\n    subgraph \"Project Context (src/beautyspot/core.py)\"\n        TaskWrapper[\"Task Wrapper&lt;br/&gt;&lt;code&gt;@Project.task&lt;/code&gt;\"]\n\n        TaskWrapper --&gt;|Check/Save Cache| SQLite[\"Metadata Store&lt;br/&gt;&lt;code&gt;sqlite3 (tasks table)&lt;/code&gt;\"]\n        TaskWrapper --&gt;|Rate Limit| Limiter[\"Rate Limiter&lt;br/&gt;&lt;code&gt;limiter.TokenBucket&lt;/code&gt;\"]\n        TaskWrapper --&gt;|Execute| Executor[\"Async/Thread Executor&lt;br/&gt;&lt;code&gt;concurrent.futures.Executor&lt;/code&gt;\"]\n\n        TaskWrapper --&gt;|Save Large Data| StorageInt[\"Storage Interface&lt;br/&gt;&lt;code&gt;storage.BlobStorageBase&lt;/code&gt;\"]\n    end\n\n    subgraph \"Storage Backends (src/beautyspot/storage.py)\"\n        StorageInt -.-&gt;|Inheritance| LocalStore[\"&lt;code&gt;class LocalStorage&lt;/code&gt;\"]\n        StorageInt -.-&gt;|Inheritance| S3Store[\"&lt;code&gt;class S3Storage&lt;/code&gt;\"]\n    end\n\n    LocalStore --&gt;|File I/O| LocalDisk[(\"Local Disk\")]\n    S3Store --&gt;|boto3| S3Bucket[(\"AWS S3 / MinIO\")]</code></pre>"},{"location":"reference/architecture/#21-metadata-store-sqlite","title":"2.1. Metadata Store (SQLite)","text":"<p>\u30bf\u30b9\u30af\u306e\u5b9f\u884c\u5c65\u6b74\u3068\u300c\u30c7\u30fc\u30bf\u306e\u5728\u308a\u51e6\uff08\u30dd\u30a4\u30f3\u30bf\uff09\u300d\u3092\u7ba1\u7406\u3057\u307e\u3059\u3002 WAL (Write-Ahead Logging) \u30e2\u30fc\u30c9\u3092\u63a1\u7528\u3057\u3001\u4e26\u884c\u8aad\u307f\u66f8\u304d\u6027\u80fd\u3092\u78ba\u4fdd\u3057\u3066\u3044\u307e\u3059\u3002</p>"},{"location":"reference/architecture/#22-blob-storage-storage-strategy","title":"2.2. Blob Storage (Storage Strategy)","text":"<p>\u753b\u50cf\u3001\u97f3\u58f0\u3001\u9577\u6587\u30c6\u30ad\u30b9\u30c8\u306a\u3069\u306e\u5de8\u5927\u306a\u30c7\u30fc\u30bf\u3092DB\u304b\u3089\u5206\u96e2\u3059\u308b \"Claim Check Pattern\" \u3092\u63a1\u7528\u3057\u3066\u3044\u307e\u3059\u3002 \u62bd\u8c61\u57fa\u5e95\u30af\u30e9\u30b9 <code>BlobStorageBase</code> \u306b\u3088\u308a\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u5dee\u3057\u66ff\u3048\u304c\u53ef\u80fd\u3067\u3059\u3002</p> <p>Note on Multi-modal Support: \u73fe\u5728\u306f <code>LocalStorage</code> \u3068 <code>S3Storage</code> \u3092\u63d0\u4f9b\u3057\u3066\u3044\u307e\u3059\u3002 \u8a2d\u8a08\u4e0a\u306f\u30d0\u30a4\u30ca\u30ea\u30c7\u30fc\u30bf\u3092\u900f\u904e\u7684\u306b\u6271\u3046\u305f\u3081\u3001\u5c06\u6765\u7684\u306a Audio (WAV/MP3) \u3084 Video (MP4) \u306a\u3069\u306e\u30de\u30eb\u30c1\u30e1\u30c7\u30a3\u30a2\u30c7\u30fc\u30bf\u3001\u304a\u3088\u3073\u305d\u308c\u3089\u306b\u7279\u5316\u3057\u305f\u30b9\u30c8\u30ec\u30fc\u30b8\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u62e1\u5f35\u3092\u898b\u636e\u3048\u3066\u3044\u307e\u3059\u3002</p>"},{"location":"reference/architecture/#23-rate-limiter-gcra","title":"2.3. Rate Limiter (GCRA)","text":"<p>GCRA (Generic Cell Rate Algorithm) \u3092\u63a1\u7528\u3057\u3066\u3044\u307e\u3059\u3002 \u901a\u5e38\u306e\u30c8\u30fc\u30af\u30f3\u30d0\u30b1\u30c3\u30c8\u3068\u7570\u306a\u308a\u3001\"Theoretical Arrival Time (TAT)\" \u3092\u7ba1\u7406\u3059\u308b\u3053\u3068\u3067\u3001\u9577\u6642\u9593\u30a2\u30a4\u30c9\u30eb\u5f8c\u306e\u30d0\u30fc\u30b9\u30c8\uff08\u96c6\u4e2d\u30a2\u30af\u30bb\u30b9\uff09\u3092\u7269\u7406\u7684\u306b\u9632\u304e\u307e\u3059\u3002</p>"},{"location":"reference/architecture/#3-class-diagram","title":"3. Class Diagram","text":"<p>\u4e3b\u8981\u30af\u30e9\u30b9\u306e\u4f9d\u5b58\u95a2\u4fc2\u3068\u8cac\u52d9\u306e\u69cb\u9020\u3067\u3059\u3002<code>Project</code> \u30af\u30e9\u30b9\u304c <code>Facade</code> \u3068\u3057\u3066\u6a5f\u80fd\u3057\u3001\u5404\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u3092\u7d71\u62ec\u3057\u3066\u3044\u307e\u3059\u3002</p> <pre><code>classDiagram\n    class Project {\n        +str name\n        +str db_path\n        +TokenBucket bucket\n        +BlobStorageBase storage\n        +Executor executor\n        -Finalizer _finalizer\n        __init__(...)\n        +task(...)\n        +limiter(...)\n        +shutdown(wait)\n        -_init_db()\n        -_check_cache_sync(key)\n        -_save_result_sync(key, ...)\n        -_shutdown_executor(executor)$\n    }\n\n    class TokenBucket {\n        +float rate\n        +int max_cost\n        +float tat\n        +consume(cost)\n        +consume_async(cost)\n        -_consume_reservation(cost)\n    }\n\n    class BlobStorageBase {\n        &lt;&lt;Abstract&gt;&gt;\n        +save(key, data)\n        +load(location)\n    }\n\n    class LocalStorage {\n        +str base_dir\n        +save(...)\n        +load(...)\n    }\n\n    class S3Storage {\n        +str bucket_name\n        +str prefix\n        +save(...)\n        +load(...)\n    }\n\n    class KeyGen {\n        &lt;&lt;Utility&gt;&gt;\n        +default(args, kwargs)\n        +from_path_stat(path)\n        +from_file_content(path)\n        -_stable_serialize_default(obj)\n    }\n\n    Project *-- TokenBucket : owns\n    Project o-- BlobStorageBase : uses (DI)\n    Project o-- concurrent.futures.Executor : uses / manages\n    BlobStorageBase &lt;|-- LocalStorage\n    BlobStorageBase &lt;|-- S3Storage\n    Project ..&gt; KeyGen : uses internal</code></pre>"},{"location":"reference/architecture/#4-database-schema-er-diagram","title":"4. Database Schema (ER Diagram)","text":"<p>SQLite\u5185\u90e8\u306e <code>tasks</code> \u30c6\u30fc\u30d6\u30eb\u306e\u30b9\u30ad\u30fc\u30de\u5b9a\u7fa9\u3067\u3059\u3002 \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306f <code>Project._init_db()</code> \u5b9f\u884c\u6642\u306b\u52d5\u7684\u30c1\u30a7\u30c3\u30af\uff08Auto-Migration\uff09\u306b\u3088\u3063\u3066\u884c\u308f\u308c\u307e\u3059\u3002</p> <pre><code>erDiagram\n    tasks {\n        TEXT cache_key PK \"MD5 Hash of (func_name + input_args + version)\"\n        TEXT func_name \"Name of the decorated function\"\n        TEXT input_id \"User-defined ID or Argument Hash\"\n        TEXT version \"Schema version of the task logic\"\n        TEXT result_type \"Storage mode: 'DIRECT' or 'FILE'\"\n        TEXT content_type \"MIME type for Dashboard rendering (e.g., 'image/png')\"\n        TEXT result_value \"JSON string or URI (path/s3://...)\"\n        TIMESTAMP updated_at \"Last execution timestamp\"\n    }</code></pre> <ul> <li><code>result_type</code>:<ul> <li><code>DIRECT</code>: \u5c0f\u3055\u3044\u30c7\u30fc\u30bf\u3002<code>result_value</code> \u30ab\u30e9\u30e0\u306b\u76f4\u63a5 JSON \u6587\u5b57\u5217\u3068\u3057\u3066\u683c\u7d0d\u3002</li> <li><code>FILE</code>: \u5927\u304d\u3044\u30c7\u30fc\u30bf (<code>save_blob=True</code>)\u3002<code>result_value</code> \u306b\u306f\u30d5\u30a1\u30a4\u30eb\u30d1\u30b9\u307e\u305f\u306f S3 URI \u3092\u683c\u7d0d\u3002</li> </ul> </li> <li><code>content_type</code>:<ul> <li>\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u3067\u306e\u53ef\u8996\u5316\u306b\u4f7f\u7528\uff08\u4f8b: <code>text/vnd.mermaid</code>, <code>image/png</code>\uff09\u3002</li> </ul> </li> </ul>"},{"location":"reference/architecture/#5-execution-flow-task-decorator","title":"5. Execution Flow (<code>@task</code> Decorator)","text":"<ol> <li>Hash Generation: \u5f15\u6570 (<code>args</code>, <code>kwargs</code>) \u3068 <code>version</code> \u304b\u3089\u4e00\u610f\u306a <code>cache_key</code> \u3092\u751f\u6210\u3002</li> <li>Cache Check: SQLite\u3092\u53c2\u7167\u3002<ul> <li>Hit -&gt; <code>result_type</code> \u306b\u5fdc\u3058\u3066\u30c7\u30fc\u30bf\u3092\u5fa9\u5143\uff08<code>pickle.load</code>\uff09\u3057\u3066\u5373\u5ea7\u306b return\u3002</li> <li>Miss -&gt; \u6b21\u3078\u9032\u3080\u3002</li> </ul> </li> <li>Execution: \u30e6\u30fc\u30b6\u30fc\u95a2\u6570\u3092\u5b9f\u884c\u3002<ul> <li>Exception: \u4f8b\u5916\u304c\u767a\u751f\u3057\u305f\u5834\u5408\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u306f\u884c\u308f\u305a \u305d\u306e\u307e\u307e\u4f8b\u5916\u3092\u4e0a\u4f4d\u3078\u4f1d\u64ad\u3055\u305b\u308b\uff08\u30d0\u30b0\u306e\u6c38\u7d9a\u5316\u9632\u6b62\uff09\u3002</li> </ul> </li> <li>Persistence:<ul> <li>Small Data -&gt; <code>DIRECT</code> \u30e2\u30fc\u30c9\u3067SQLite\u306bJSON\u4fdd\u5b58\u3002</li> <li>Large Data (<code>save_blob=True</code>) -&gt; <code>FILE</code> \u30e2\u30fc\u30c9\u3067Storage\u306b\u4fdd\u5b58\u3057\u3001\u30d1\u30b9\u306e\u307f\u3092SQLite\u306b\u8a18\u9332\u3002</li> </ul> </li> </ol>"},{"location":"reference/architecture/#6-key-technical-decisions-adr-summary","title":"6. Key Technical Decisions (ADR Summary)","text":"<p>\u3053\u306e\u8a2d\u8a08\u306b\u81f3\u3063\u305f\u91cd\u8981\u306a\u610f\u601d\u6c7a\u5b9a\u306e\u5c65\u6b74\u3067\u3059\u3002</p> <ul> <li>ADR-0001: Stable Hashing<ul> <li><code>pickle</code> \u3067\u306f\u306a\u304f <code>json</code> \u30d9\u30fc\u30b9\u306e\u6b63\u898f\u5316\u3092\u63a1\u7528\u3057\u3001\u7570\u306a\u308b\u74b0\u5883\u9593\u3067\u306e\u30ad\u30fc\u306e\u4e00\u81f4\u7387\u3092\u5411\u4e0a\u3055\u305b\u305f\u3002</li> </ul> </li> <li>ADR-0002: GCRA Rate Limiter<ul> <li>\u5358\u7d14\u306a\u30c8\u30fc\u30af\u30f3\u30d0\u30b1\u30c3\u30c8\u306e\u300c\u30d0\u30fc\u30b9\u30c8\u554f\u984c\u300d\u3092\u89e3\u6c7a\u3059\u308b\u305f\u3081\u306b\u3001TAT\u30d9\u30fc\u30b9\u306e\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3078\u79fb\u884c\u3057\u305f\u3002</li> </ul> </li> <li>ADR-0003: Resilient Deserialization<ul> <li>\u30b3\u30fc\u30c9\u5909\u66f4\u306b\u3088\u308b <code>pickle</code> \u8aad\u307f\u8fbc\u307f\u30a8\u30e9\u30fc\u3092\u691c\u77e5\u3057\u3001\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u305a\u306b\u300c\u30ad\u30e3\u30c3\u30b7\u30e5\u30df\u30b9\u300d\u3068\u3057\u3066\u6271\u3044\u518d\u8a08\u7b97\u3055\u305b\u308b\u30d5\u30a7\u30a4\u30eb\u30bb\u30fc\u30d5\u6a5f\u69cb\u3092\u5c0e\u5165\u3002</li> </ul> </li> <li>ADR-0004: Executor Lifecycle via <code>weakref</code><ul> <li><code>atexit</code> \u306b\u3088\u308b\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u306f\u30e1\u30e2\u30ea\u30ea\u30fc\u30af\uff08\u5faa\u74b0\u53c2\u7167\uff09\u306e\u30ea\u30b9\u30af\u304c\u3042\u308b\u305f\u3081\u3001<code>weakref.finalize</code> \u3092\u63a1\u7528\u3057\u3066\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u306e\u5b89\u5168\u306a\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3092\u5b9f\u73fe\u3057\u305f\u3002</li> </ul> </li> <li>ADR-0006: Semantic Content Type<ul> <li>\u30d0\u30a4\u30ca\u30ea\u30c7\u30fc\u30bf\u306e\u4e2d\u8eab\u3092\u63a8\u6e2c\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001\u4fdd\u5b58\u6642\u306b <code>content_type</code> \u3092\u660e\u793a\u7684\u306b\u8a18\u9332\u3057\u3001\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u3067\u306e\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u7cbe\u5ea6\u3092\u5411\u4e0a\u3055\u305b\u305f\u3002</li> </ul> </li> </ul>"},{"location":"reference/core/","title":"Project (Core)","text":""},{"location":"reference/core/#beautyspot.core","title":"<code>beautyspot.core</code>","text":""},{"location":"reference/core/#beautyspot.core.Project","title":"<code>Project</code>","text":"Source code in <code>src/beautyspot/core.py</code> <pre><code>class Project:\n    def __init__(\n        self,\n        name: str,\n        db: str | TaskDB | None = None,\n        storage_path: str = \"./blobs\",\n        s3_opts: dict | None = None,\n        tpm: int = 10000,\n        io_workers: int = 4,\n        executor: Optional[Executor] = None,\n        storage: Optional[BlobStorageBase] = None,\n    ):\n        self.name = name\n\n        if db is None:\n            self.db = SQLiteTaskDB(f\"{name}.db\")\n        elif isinstance(db, str):\n            self.db = SQLiteTaskDB(db)\n        elif isinstance(db, TaskDB):\n            self.db = db\n        else:\n            raise TypeError(\"Argument 'db' must be a string (path) or a TaskDB instance.\")\n\n        self.db.init_schema()\n\n        # --- Rate Limiter ---\n        self.bucket = TokenBucket(tpm)\n\n        # --- Serializer Setup ---\n        self.serializer = MsgpackSerializer()\n\n        # --- Storage Selection ---\n        if storage is not None:\n            self.storage = storage\n        else:\n            self.storage = create_storage(storage_path, s3_opts)\n\n        # -- Executor Management ---\n        if executor is not None:\n            self.executor = executor\n            self._own_executor = False\n        else:\n            self.executor = ThreadPoolExecutor(max_workers=io_workers)\n            self._own_executor = True\n\n            # \u81ea\u52d5\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u306e\u767b\u9332\n            # self\u3078\u306e\u5f37\u3044\u53c2\u7167\u3092\u6301\u305f\u305b\u306a\u3044\u3088\u3046\u3001executor\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3060\u3051\u3092\u6b8b\u3059\n            self._finalizer = weakref.finalize(self, self._shutdown_executor, self.executor)\n\n    @staticmethod\n    def _shutdown_executor(executor: Executor):\n        \"\"\"\n        \u5185\u90e8Executor\u7528\u306e\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u95a2\u6570\n        \"\"\"\n        executor.shutdown(wait=True)\n\n    def shutdown(self, wait: bool = True):\n        \"\"\"\n        \u624b\u52d5\u3067\u30ea\u30bd\u30fc\u30b9\u3092\u89e3\u653e\u3059\u308b\u5834\u5408\u306b\u4f7f\u7528\n        \"\"\"\n        if self._own_executor and self._finalizer.alive:\n            self._finalizer()\n\n    def register_type(self, type_: Type, code: int, encoder: Callable, decoder: Callable):\n        \"\"\"\n        Register a custom type for serialization (Msgpack Extension Type).\n\n        Args:\n            type_: The class to handle (e.g. MyClass)\n            code: Unique integer ID (0-127) for this type\n            encoder: Function that converts obj -&gt; bytes\n            decoder: Function that converts bytes -&gt; obj\n        \"\"\"\n        self.serializer.register(type_, code, encoder, decoder)\n\n    # --- Core Logic (Sync) ---\n    def _check_cache_sync(self, cache_key: str) -&gt; Any:\n        \"\"\"\u623b\u308a\u5024\u304c None \u306a\u3089\u30ad\u30e3\u30c3\u30b7\u30e5\u30df\u30b9\"\"\"\n        entry = self.db.get(cache_key)\n\n        if entry:\n            r_type = entry[\"result_type\"]\n            r_val = entry[\"result_value\"]\n            if r_type == 'DIRECT':\n                return json.loads(r_val)\n            elif r_type == 'FILE':\n                try:\n                    data_bytes = self.storage.load(r_val)\n                    return self.serializer.loads(data_bytes)\n                except FileNotFoundError:\n                    logger.warning(f\"Cache blob missing for key {cache_key}. Re-computing.\")\n                    return None\n                except (ValueError, SerializationError, Exception) as e:\n                    logger.warning(\n                        f\"\u26a0\ufe0f Cache corrupted or incompatible for '{cache_key}'. Re-computing...\\n\"\n                        f\"   Error: {e}\"\n                    )\n                    return None\n                # except CacheCorruptedError as e:\n                #     logger.warning(\n                #         f\"\u26a0\ufe0f Cache corrupted for '{cache_key}' (likely due to code changes). Re-computing...\\n\"\n                #         f\"   Error: {e}\\n\"\n                #         f\"   Hint: Consider updating 'version' in @task(version=...) to avoid unintended recalculation.\"\n                #     )\n                #     return None\n        return None\n\n    def _save_result_sync(self, cache_key: str, func_name: str, input_id: str, version: str | None, result: Any, content_type: str | None, save_blob: bool):\n        if save_blob:\n            data_bytes = self.serializer.dumps(result)\n            r_val = self.storage.save(cache_key, data_bytes)\n            r_type = 'FILE'\n        else:\n            # Small data: Keep using JSON for now to maintain DB readability\n            # Note: This limits `save_blob=False` to JSON-serializable types only.\n            # If users want to use Custom Types, they should prefer `save_blob=True` \n            # OR we can switch this to base64 encoded msgpack in the future.\n            r_type = 'DIRECT'\n            r_val = json.dumps(result, default=str)\n\n        self.db.save(\n            cache_key=cache_key,\n            func_name=func_name,\n            input_id=input_id,\n            version=version,\n            result_type=r_type,\n            content_type=content_type,\n            result_value=r_val,\n        )\n\n    # --- Decorators ---\n\n    def limiter(self, cost: Union[int, Callable] = 1):\n        \"\"\"Rate Limiting Decorator\"\"\"\n        def decorator(func):\n            is_async = inspect.iscoroutinefunction(func)\n\n            @functools.wraps(func)\n            def sync_wrapper(*args, **kwargs):\n                c = cost(*args, **kwargs) if callable(cost) else cost\n                self.bucket.consume(c)\n                return func(*args, **kwargs)\n\n            @functools.wraps(func)\n            async def async_wrapper(*args, **kwargs):\n                c = cost(*args, **kwargs) if callable(cost) else cost\n                await self.bucket.consume_async(c)\n                return await func(*args, **kwargs)\n\n            return async_wrapper if is_async else sync_wrapper\n        return decorator\n\n    def task(\n        self,\n        _func: Optional[Callable] = None,\n        *,\n        save_blob: bool = False,\n        input_key_fn: Optional[Callable] = None,\n        version: str | None = None,\n        content_type: Optional[str] = None,\n    ):\n        \"\"\"\n        Resumable Task Decorator.\n\n        Args:\n            save_blob: If True, saves result using Storage (pickle). If False, saves to DB directly (JSON).\n            input_key_fn: Custom function to generate input ID from args/kwargs.\n            version: Explicit version string. Change this to invalidate old cache entries.\n        \"\"\"\n        def decorator(func):\n            is_async = inspect.iscoroutinefunction(func)\n\n            # Key Gen Helper\n            def make_key(args, kwargs):\n                from .utils import KeyGen\n                iid = input_key_fn(*args, **kwargs) if input_key_fn else KeyGen.default(args, kwargs)\n\n                key_source = f\"{func.__name__}:{iid}\"\n                if version:\n                    key_source += f\":{version}\"\n\n                ck = hashlib.md5(key_source.encode()).hexdigest()\n                return iid, ck\n\n            @functools.wraps(func)\n            def sync_wrapper(*args, **kwargs):\n                iid, ck = make_key(args, kwargs)\n\n                # 1. Check Cache\n                cached = self._check_cache_sync(ck)\n                if cached is not None: return cached\n\n                # 2. Execute\n                res = func(*args, **kwargs)\n\n                # 3. Save\n                self._save_result_sync(ck, func.__name__, str(iid), version, res, content_type, save_blob)\n                return res\n\n            @functools.wraps(func)\n            async def async_wrapper(*args, **kwargs):\n                iid, ck = make_key(args, kwargs)\n                loop = asyncio.get_running_loop()\n\n                # 1. Check Cache (Offload IO)\n                cached = await loop.run_in_executor(self.executor, self._check_cache_sync, ck)\n                if cached is not None: return cached\n\n                # 2. Execute (Async)\n                res = await func(*args, **kwargs)\n\n                # 3. Save (Offload IO)\n                await loop.run_in_executor(self.executor, self._save_result_sync, ck, func.__name__, str(iid), version, res, content_type, save_blob)\n                return res\n\n            return async_wrapper if is_async else sync_wrapper\n\n        # \u30b1\u30fc\u30b91: @project.task \u3068\u3057\u3066\u547c\u3070\u308c\u305f\u5834\u5408\n        # _func \u306b\u30c7\u30b3\u30ec\u30fc\u30c8\u5bfe\u8c61\u306e\u95a2\u6570\u304c\u5165\u3063\u3066\u304f\u308b\n        if _func is not None and callable(_func):\n            return decorator(_func)\n\n        # \u30b1\u30fc\u30b92: @project.task(save_blob=True) \u3068\u3057\u3066\u547c\u3070\u308c\u305f\u5834\u5408\n        # _func \u306f None \u306b\u306a\u308a\u3001decorator\u81ea\u4f53\u3092\u8fd4\u3059\uff08\u305d\u306e\u5f8cPython\u304cfunc\u3092\u5165\u308c\u3066\u547c\u3093\u3067\u304f\u308c\u308b\uff09\n        return decorator\n</code></pre>"},{"location":"reference/core/#beautyspot.core.Project.limiter","title":"<code>limiter(cost=1)</code>","text":"<p>Rate Limiting Decorator</p> Source code in <code>src/beautyspot/core.py</code> <pre><code>def limiter(self, cost: Union[int, Callable] = 1):\n    \"\"\"Rate Limiting Decorator\"\"\"\n    def decorator(func):\n        is_async = inspect.iscoroutinefunction(func)\n\n        @functools.wraps(func)\n        def sync_wrapper(*args, **kwargs):\n            c = cost(*args, **kwargs) if callable(cost) else cost\n            self.bucket.consume(c)\n            return func(*args, **kwargs)\n\n        @functools.wraps(func)\n        async def async_wrapper(*args, **kwargs):\n            c = cost(*args, **kwargs) if callable(cost) else cost\n            await self.bucket.consume_async(c)\n            return await func(*args, **kwargs)\n\n        return async_wrapper if is_async else sync_wrapper\n    return decorator\n</code></pre>"},{"location":"reference/core/#beautyspot.core.Project.register_type","title":"<code>register_type(type_, code, encoder, decoder)</code>","text":"<p>Register a custom type for serialization (Msgpack Extension Type).</p> <p>Parameters:</p> Name Type Description Default <code>type_</code> <code>Type</code> <p>The class to handle (e.g. MyClass)</p> required <code>code</code> <code>int</code> <p>Unique integer ID (0-127) for this type</p> required <code>encoder</code> <code>Callable</code> <p>Function that converts obj -&gt; bytes</p> required <code>decoder</code> <code>Callable</code> <p>Function that converts bytes -&gt; obj</p> required Source code in <code>src/beautyspot/core.py</code> <pre><code>def register_type(self, type_: Type, code: int, encoder: Callable, decoder: Callable):\n    \"\"\"\n    Register a custom type for serialization (Msgpack Extension Type).\n\n    Args:\n        type_: The class to handle (e.g. MyClass)\n        code: Unique integer ID (0-127) for this type\n        encoder: Function that converts obj -&gt; bytes\n        decoder: Function that converts bytes -&gt; obj\n    \"\"\"\n    self.serializer.register(type_, code, encoder, decoder)\n</code></pre>"},{"location":"reference/core/#beautyspot.core.Project.shutdown","title":"<code>shutdown(wait=True)</code>","text":"<p>\u624b\u52d5\u3067\u30ea\u30bd\u30fc\u30b9\u3092\u89e3\u653e\u3059\u308b\u5834\u5408\u306b\u4f7f\u7528</p> Source code in <code>src/beautyspot/core.py</code> <pre><code>def shutdown(self, wait: bool = True):\n    \"\"\"\n    \u624b\u52d5\u3067\u30ea\u30bd\u30fc\u30b9\u3092\u89e3\u653e\u3059\u308b\u5834\u5408\u306b\u4f7f\u7528\n    \"\"\"\n    if self._own_executor and self._finalizer.alive:\n        self._finalizer()\n</code></pre>"},{"location":"reference/core/#beautyspot.core.Project.task","title":"<code>task(_func=None, *, save_blob=False, input_key_fn=None, version=None, content_type=None)</code>","text":"<p>Resumable Task Decorator.</p> <p>Parameters:</p> Name Type Description Default <code>save_blob</code> <code>bool</code> <p>If True, saves result using Storage (pickle). If False, saves to DB directly (JSON).</p> <code>False</code> <code>input_key_fn</code> <code>Optional[Callable]</code> <p>Custom function to generate input ID from args/kwargs.</p> <code>None</code> <code>version</code> <code>str | None</code> <p>Explicit version string. Change this to invalidate old cache entries.</p> <code>None</code> Source code in <code>src/beautyspot/core.py</code> <pre><code>def task(\n    self,\n    _func: Optional[Callable] = None,\n    *,\n    save_blob: bool = False,\n    input_key_fn: Optional[Callable] = None,\n    version: str | None = None,\n    content_type: Optional[str] = None,\n):\n    \"\"\"\n    Resumable Task Decorator.\n\n    Args:\n        save_blob: If True, saves result using Storage (pickle). If False, saves to DB directly (JSON).\n        input_key_fn: Custom function to generate input ID from args/kwargs.\n        version: Explicit version string. Change this to invalidate old cache entries.\n    \"\"\"\n    def decorator(func):\n        is_async = inspect.iscoroutinefunction(func)\n\n        # Key Gen Helper\n        def make_key(args, kwargs):\n            from .utils import KeyGen\n            iid = input_key_fn(*args, **kwargs) if input_key_fn else KeyGen.default(args, kwargs)\n\n            key_source = f\"{func.__name__}:{iid}\"\n            if version:\n                key_source += f\":{version}\"\n\n            ck = hashlib.md5(key_source.encode()).hexdigest()\n            return iid, ck\n\n        @functools.wraps(func)\n        def sync_wrapper(*args, **kwargs):\n            iid, ck = make_key(args, kwargs)\n\n            # 1. Check Cache\n            cached = self._check_cache_sync(ck)\n            if cached is not None: return cached\n\n            # 2. Execute\n            res = func(*args, **kwargs)\n\n            # 3. Save\n            self._save_result_sync(ck, func.__name__, str(iid), version, res, content_type, save_blob)\n            return res\n\n        @functools.wraps(func)\n        async def async_wrapper(*args, **kwargs):\n            iid, ck = make_key(args, kwargs)\n            loop = asyncio.get_running_loop()\n\n            # 1. Check Cache (Offload IO)\n            cached = await loop.run_in_executor(self.executor, self._check_cache_sync, ck)\n            if cached is not None: return cached\n\n            # 2. Execute (Async)\n            res = await func(*args, **kwargs)\n\n            # 3. Save (Offload IO)\n            await loop.run_in_executor(self.executor, self._save_result_sync, ck, func.__name__, str(iid), version, res, content_type, save_blob)\n            return res\n\n        return async_wrapper if is_async else sync_wrapper\n\n    # \u30b1\u30fc\u30b91: @project.task \u3068\u3057\u3066\u547c\u3070\u308c\u305f\u5834\u5408\n    # _func \u306b\u30c7\u30b3\u30ec\u30fc\u30c8\u5bfe\u8c61\u306e\u95a2\u6570\u304c\u5165\u3063\u3066\u304f\u308b\n    if _func is not None and callable(_func):\n        return decorator(_func)\n\n    # \u30b1\u30fc\u30b92: @project.task(save_blob=True) \u3068\u3057\u3066\u547c\u3070\u308c\u305f\u5834\u5408\n    # _func \u306f None \u306b\u306a\u308a\u3001decorator\u81ea\u4f53\u3092\u8fd4\u3059\uff08\u305d\u306e\u5f8cPython\u304cfunc\u3092\u5165\u308c\u3066\u547c\u3093\u3067\u304f\u308c\u308b\uff09\n    return decorator\n</code></pre>"},{"location":"reference/philosophy/","title":"\ud83c\udf11 The Philosophy of beautyspot","text":"<p><code>beautyspot</code> \u306f\u3001\u751f\u6210AI\u3068\u30de\u30eb\u30c1\u30e2\u30fc\u30c0\u30eb\u30c7\u30fc\u30bf\u3092\u6271\u3046\u30b7\u30fc\u30f3\u306b\u304a\u3044\u3066\u3001\u958b\u767a\u8005\u304c\u300c\u30ed\u30b8\u30c3\u30af\u305d\u306e\u3082\u306e\u300d\u306b\u6ca1\u982d\u3057\u3001\u5408\u7406\u7684\u304b\u3064\u9ad8\u901f\u306b\u4fa1\u5024\u3092\u751f\u307f\u51fa\u3059\u305f\u3081\u306e\u958b\u767a\u30c4\u30fc\u30eb\u3067\u3059\u3002</p>"},{"location":"reference/philosophy/#1-core-philosophy","title":"1. Core Philosophy (\u8a2d\u8a08\u601d\u60f3)","text":""},{"location":"reference/philosophy/#kuroko-and-hokuro-non-intrusive-design","title":"Kuroko and Hokuro: Non-Intrusive Design","text":"<p>\u4e3b\u5f79\u306f\u5e38\u306b\u3001\u3042\u306a\u305f\u306e\u30b3\u30fc\u30c9\uff08\u30ed\u30b8\u30c3\u30af\uff09\u3067\u3059\u3002 <code>beautyspot</code> \u306f\u30c7\u30b3\u30ec\u30fc\u30bf\u3068\u3044\u3046\u5f62\u3067\u6a5f\u80fd\u3092\u63d0\u4f9b\u3057\u307e\u3059\u304c\u3001\u3042\u306a\u305f\u306e\u30af\u30e9\u30b9\u8a2d\u8a08\u3084\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306b\u306f\u4e00\u5207\u5e72\u6e09\u3057\u307e\u305b\u3093\u3002 \u7d99\u627f\u3092\u5f37\u8981\u305b\u305a\u3001\u8907\u96d1\u306a\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3082\u3042\u308a\u307e\u305b\u3093\u3002 \u300c\u9ed2\u5b50\u300d\u3068\u3057\u3066\u3001\u88cf\u5074\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u3084\u30ec\u30fc\u30c8\u5236\u9650\u3068\u3044\u3063\u305f\u8907\u96d1\u306a\u5236\u5fa1\u3092\u4e00\u624b\u306b\u5f15\u304d\u53d7\u3051\u3001\u3042\u306a\u305f\u306e\u30b3\u30fc\u30c9\u3092\u7f8e\u3057\u304f\u300c\u7d14\u7c8b\u306a\u30ed\u30b8\u30c3\u30af\u300d\u306e\u72b6\u614b\u306b\u4fdd\u3064\u3053\u3068\u306b\u8ca2\u732e\u3057\u307e\u3059\u3002</p>"},{"location":"reference/philosophy/#rational-iteration-speed-with-confidence","title":"Rational Iteration: Speed with Confidence","text":"<p>\u5065\u5168\u306a\u8a66\u884c\u932f\u8aa4\u306e\u305f\u3081\u306e\u57fa\u76e4\u3092\u3001\u6700\u901f\u6700\u8efd\u91cf\u3067\u63d0\u4f9b\u3057\u307e\u3059\u3002 API\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3001\u9014\u4e2d\u505c\u6b62\u304b\u3089\u306e\u30ea\u30ab\u30d0\u30ea\u3001\u305d\u3057\u3066\u30ad\u30e3\u30c3\u30b7\u30e5\u7ba1\u7406\u3002\u3053\u308c\u3089\u306f\u3001\u751f\u6210AI\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30a8\u30f3\u30b8\u30cb\u30a2\u30ea\u30f3\u30b0\u306b\u3068\u3063\u3066\u672c\u8cea\u7684\u306a\u8981\u7d20\u3067\u3001\u5408\u7406\u7684\u306a\u8a66\u884c\u932f\u8aa4\u3092\u884c\u3046\u305f\u3081\u306b\u4e0d\u53ef\u6b20\u306a\u300c\u8db3\u5834\u300d\u3067\u3059\u3002 \u3057\u304b\u3057\u3001\u3053\u306e\u8db3\u5834\u3092\u7d44\u3080\u305f\u3081\u306b\u6642\u9593\u3092\u8cbb\u3084\u3057\u3066\u306f\u3001\u672c\u672b\u8ee2\u5012\u3067\u3059\u3002 <code>beautyspot</code> \u306f\u3001\u3053\u306e\u5fc5\u9808\u306e\u8db3\u5834\u3092\u5373\u5ea7\u306b\u63d0\u4f9b\u3057\u307e\u3059\u3002\u300c\u5931\u6557\u3057\u3066\u3082\u5927\u4e08\u592b\u300d\u300c\u6b62\u307e\u3063\u3066\u3082\u518d\u958b\u3067\u304d\u308b\u300d\u3068\u3044\u3046\u5b89\u5fc3\u611f\u304c\u30c1\u30e3\u30ec\u30f3\u30b8\u3092\u5bb9\u6613\u306b\u3057\u3001\u767a\u60f3\u306e\u4f59\u5730\u3092\u5e83\u3052\u3001\u30b9\u30d4\u30fc\u30c9\u3068\u54c1\u8cea\u3092\u540c\u6642\u306b\u5f15\u304d\u4e0a\u3052\u307e\u3059\u3002</p>"},{"location":"reference/philosophy/#transparent-existence-no-lock-in","title":"Transparent Existence: No Lock-in","text":"<p>\u7a7a\u6c17\u306e\u3088\u3046\u306b\u7e8f\u3044\u3001\u3044\u3064\u3067\u3082\u8131\u3052\u308b\u3053\u3068\u3002 \u7279\u5b9a\u306e\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3078\u306e\u30ed\u30c3\u30af\u30a4\u30f3\uff08\u56f2\u3044\u8fbc\u307f\uff09\u3092\u5acc\u3044\u307e\u3059\u3002 \u30c7\u30b3\u30ec\u30fc\u30bf\u3092\u5916\u3057\u305f\u77ac\u9593\u3001\u3042\u306a\u305f\u306e\u30b3\u30fc\u30c9\u306f\u6a19\u6e96\u7684\u306a Python \u95a2\u6570\u306b\u623b\u308a\u307e\u3059\u3002 \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u304c\u6210\u9577\u3057\u3001\u5927\u898f\u6a21\u306a\u5206\u6563\u57fa\u76e4\u304c\u5fc5\u8981\u306b\u306a\u3063\u305f\u3068\u304d\u2500\u2500\u305d\u308c\u304c <code>beautyspot</code> \u304b\u3089\u306e\u300c\u5352\u696d\u300d\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u3059\u3002\u305d\u306e\u6642\u3001\u3042\u306a\u305f\u306f\u75db\u307f\u306a\u304f\u6b21\u306e\u30b9\u30c6\u30fc\u30b8\u3078\u79fb\u884c\u3067\u304d\u307e\u3059\u3002\u305d\u308c\u307e\u3067\u306e\u9593\u3001\u79c1\u305f\u3061\u306f\u6700\u9ad8\u306e\u4f34\u8d70\u8005\u3068\u3057\u3066\u632f\u308b\u821e\u3044\u307e\u3059\u3002</p>"},{"location":"reference/philosophy/#2-anti-goals","title":"2. Anti-Goals (\u3084\u3089\u306a\u3044\u3053\u3068)","text":"<p>\u3053\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30b7\u30f3\u30d7\u30eb\u3055\u3068\u300c\u5352\u696d\u306e\u3057\u3084\u3059\u3055\u300d\u3092\u5b88\u308b\u305f\u3081\u3001\u4ee5\u4e0b\u306e\u6a5f\u80fd\u306f\u610f\u56f3\u7684\u306b\u5b9f\u88c5\u3057\u307e\u305b\u3093\u3002</p>"},{"location":"reference/philosophy/#not-a-distributed-system","title":"Not a Distributed System (\u5206\u6563\u30b7\u30b9\u30c6\u30e0\u3067\u306f\u306a\u3044)","text":"<p>Redis \u3084 Memcached \u3092\u524d\u63d0\u3068\u3057\u305f\u5206\u6563\u30ed\u30c3\u30af\u3001\u30ea\u30fc\u30c0\u30fc\u9078\u51fa\u3001\u6574\u5408\u6027\u30d7\u30ed\u30c8\u30b3\u30eb\uff08Raft/Paxos\uff09\u306f\u5b9f\u88c5\u3057\u307e\u305b\u3093\u3002 \u3053\u308c\u3089\u304c\u5fc5\u8981\u306a\u898f\u6a21\u306f <code>beautyspot</code> \u306e\u9818\u5206\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\u79c1\u305f\u3061\u306f\u3001\u30ed\u30fc\u30ab\u30eb\uff08\u307e\u305f\u306f\u5358\u4e00\u30ce\u30fc\u30c9\uff09\u74b0\u5883\u306b\u304a\u3044\u3066\u3001\u6700\u901f\u6700\u8efd\u91cf\u306e\u958b\u767a\u4f53\u9a13\u3092\u63d0\u4f9b\u3059\u308b\u3053\u3068\u306b\u96c6\u4e2d\u3057\u307e\u3059\u3002</p>"},{"location":"reference/philosophy/#not-a-workflow-engine","title":"Not a Workflow Engine (\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u30a8\u30f3\u30b8\u30f3\u3067\u306f\u306a\u3044)","text":"<p>Airflow \u3084 Prefect \u306e\u3088\u3046\u306a\u3001DAG\uff08\u6709\u5411\u975e\u5de1\u56de\u30b0\u30e9\u30d5\uff09\u306b\u3088\u308b\u4f9d\u5b58\u95a2\u4fc2\u89e3\u6c7a\u3084\u3001\u8907\u96d1\u306a\u30ea\u30c8\u30e9\u30a4\u30b9\u30b1\u30b8\u30e5\u30fc\u30ea\u30f3\u30b0\u306f\u63d0\u4f9b\u3057\u307e\u305b\u3093\u3002 \u3042\u304f\u307e\u3067\u300c\u95a2\u6570\u5358\u4f4d\u300d\u306e\u5b9f\u884c\u5236\u5fa1\u306b\u7559\u3081\u307e\u3059\u3002</p>"},{"location":"reference/philosophy/#not-a-job-queue","title":"Not a Job Queue (\u30b8\u30e7\u30d6\u30ad\u30e5\u30fc\u3067\u306f\u306a\u3044)","text":"<p>Celery \u306e\u3088\u3046\u306a\u3001\u30ef\u30fc\u30ab\u30fc\u3078\u306e\u30bf\u30b9\u30af\u5206\u6563\uff08Dispatch\uff09\u6a5f\u80fd\u306f\u6301\u3061\u307e\u305b\u3093\u3002 \u3053\u306e\u30c4\u30fc\u30eb\u306f\u300c\u95a2\u6570\u3092\u547c\u3073\u51fa\u3057\u305f\u305d\u306e\u5834\u300d\u3067\u4ed5\u4e8b\u3092\u3057\u307e\u3059\u3002</p>"},{"location":"reference/philosophy/#not-an-observability-platform","title":"Not an Observability Platform (\u76e3\u8996\u57fa\u76e4\u3067\u306f\u306a\u3044)","text":"<p>Datadog \u3084 Prometheus \u306e\u3088\u3046\u306a\u3001\u30e1\u30c8\u30ea\u30af\u30b9\u306e\u84c4\u7a4d\u30fb\u76e3\u8996\u30fb\u30a2\u30e9\u30fc\u30c8\u6a5f\u80fd\u306f\u5185\u88fd\u3057\u307e\u305b\u3093\u3002 \u30ed\u30b0\u3084\u30a4\u30d9\u30f3\u30c8\u306f\u300c\u5410\u304d\u51fa\u3059\u300d\u3053\u3068\u306b\u5fb9\u3057\u3001\u305d\u306e\u6d3b\u7528\u306f\u5c02\u7528\u306e\u30c4\u30fc\u30eb\u306b\u59d4\u306d\u307e\u3059\u3002\u4ed8\u5c5e\u306e\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u306f\u3001\u3042\u304f\u307e\u3067\u958b\u767a\u4e2d\u306e\u300c\u30c7\u30d0\u30c3\u30b0\u3068\u73fe\u72b6\u78ba\u8a8d\u300d\u306e\u305f\u3081\u306e\u7c21\u6613\u30d3\u30e5\u30fc\u30a2\u3067\u3059\u3002</p>"},{"location":"reference/storage/","title":"Storage","text":""},{"location":"reference/storage/#beautyspot.storage","title":"<code>beautyspot.storage</code>","text":""},{"location":"reference/storage/#beautyspot.storage.CacheCorruptedError","title":"<code>CacheCorruptedError</code>","text":"<p>               Bases: <code>Exception</code></p> <p>Raised when blob data cannot be deserialized (e.g. code changes).</p> Source code in <code>src/beautyspot/storage.py</code> <pre><code>class CacheCorruptedError(Exception):\n    \"\"\"Raised when blob data cannot be deserialized (e.g. code changes).\"\"\"\n    pass\n</code></pre>"},{"location":"reference/storage/#beautyspot.storage.create_storage","title":"<code>create_storage(path, options=None)</code>","text":"<p>Factory function to create a storage backend based on the path protocol.</p> <p>Parameters:</p> Name Type Description Default <code>path</code> <code>str</code> <p>Storage path or URI (e.g., \"./data\", \"s3://my-bucket/prefix\").</p> required <code>options</code> <code>dict | None</code> <p>Extra options passed to the backend (e.g., boto3 client args).</p> <code>None</code> Source code in <code>src/beautyspot/storage.py</code> <pre><code>def create_storage(path: str, options: dict | None = None) -&gt; BlobStorageBase:\n    \"\"\"\n    Factory function to create a storage backend based on the path protocol.\n\n    Args:\n        path: Storage path or URI (e.g., \"./data\", \"s3://my-bucket/prefix\").\n        options: Extra options passed to the backend (e.g., boto3 client args).\n    \"\"\"\n    if path.startswith(\"s3://\"):\n        return S3Storage(path, options)\n\n    # \u5c06\u6765\u7684\u306a\u62e1\u5f35\u30dd\u30a4\u30f3\u30c8 (\u4f8b: gs://, azure://)\n    # if path.startswith(\"gs://\"):\n    #     return GCSStorage(path, options)\n\n    return LocalStorage(path)\n</code></pre>"},{"location":"reference/types/","title":"Types","text":""},{"location":"reference/types/#beautyspot.types","title":"<code>beautyspot.types</code>","text":""},{"location":"reference/types/#beautyspot.types.ContentType","title":"<code>ContentType</code>","text":"<p>Supported semantic content types for beautyspot tasks. Used by the dashboard to determine the appropriate rendering widget.</p> Source code in <code>src/beautyspot/types.py</code> <pre><code>class ContentType:\n    \"\"\"\n    Supported semantic content types for beautyspot tasks.\n    Used by the dashboard to determine the appropriate rendering widget.\n    \"\"\"\n    TEXT = \"text/plain\"\n    JSON = \"application/json\"\n    MARKDOWN = \"text/markdown\"\n    PNG = \"image/png\"\n    JPEG = \"image/jpeg\"\n    MERMAID = \"text/vnd.mermaid\"\n    GRAPHVIZ = \"text/vnd.graphviz\"\n    HTML = \"text/html\"\n</code></pre>"},{"location":"reference/utils/","title":"Utils","text":""},{"location":"reference/utils/#beautyspot.utils","title":"<code>beautyspot.utils</code>","text":""},{"location":"reference/utils/#beautyspot.utils.KeyGen","title":"<code>KeyGen</code>","text":"Source code in <code>src/beautyspot/utils.py</code> <pre><code>class KeyGen:\n    @staticmethod\n    def from_path_stat(filepath: str) -&gt; str:\n        \"\"\"Fast: path + size + mtime\"\"\"\n        if not os.path.exists(filepath): return f\"MISSING_{filepath}\"\n        stat = os.stat(filepath)\n        identifier = f\"{filepath}_{stat.st_size}_{stat.st_mtime}\"\n        return hashlib.md5(identifier.encode()).hexdigest()\n\n    @staticmethod\n    def from_file_content(filepath: str) -&gt; str:\n        \"\"\"Strict: file content hash\"\"\"\n        if not os.path.exists(filepath): return f\"MISSING_{filepath}\"\n        hasher = hashlib.md5()\n        # Include extension to distinguish format changes\n        hasher.update(os.path.splitext(filepath)[1].lower().encode())\n        try:\n            with open(filepath, 'rb') as f:\n                while chunk := f.read(65536):\n                    hasher.update(chunk)\n        except OSError: return f\"ERROR_{filepath}\"\n        return hasher.hexdigest()\n\n    @staticmethod\n    def default(args: tuple, kwargs: dict) -&gt; str:\n        \"\"\"\n        Fallback: Stable JSON serialization of args/kwargs.\n        Handles custom objects and sets gracefully.\n        \"\"\"\n        try:\n            # Serialize with a smart default handler\n            s = json.dumps(\n                {\"a\": args, \"k\": kwargs}, \n                sort_keys=True, \n                default=_stable_serialize_default,\n                ensure_ascii=False\n            )\n            return hashlib.md5(s.encode()).hexdigest()\n        except Exception:\n            # Fallback for circular references or truly unserializable objects.\n            # We might want to log a warning here in the future.\n            return hashlib.md5(str((args, kwargs)).encode()).hexdigest()\n</code></pre>"},{"location":"reference/utils/#beautyspot.utils.KeyGen.default","title":"<code>default(args, kwargs)</code>  <code>staticmethod</code>","text":"<p>Fallback: Stable JSON serialization of args/kwargs. Handles custom objects and sets gracefully.</p> Source code in <code>src/beautyspot/utils.py</code> <pre><code>@staticmethod\ndef default(args: tuple, kwargs: dict) -&gt; str:\n    \"\"\"\n    Fallback: Stable JSON serialization of args/kwargs.\n    Handles custom objects and sets gracefully.\n    \"\"\"\n    try:\n        # Serialize with a smart default handler\n        s = json.dumps(\n            {\"a\": args, \"k\": kwargs}, \n            sort_keys=True, \n            default=_stable_serialize_default,\n            ensure_ascii=False\n        )\n        return hashlib.md5(s.encode()).hexdigest()\n    except Exception:\n        # Fallback for circular references or truly unserializable objects.\n        # We might want to log a warning here in the future.\n        return hashlib.md5(str((args, kwargs)).encode()).hexdigest()\n</code></pre>"},{"location":"reference/utils/#beautyspot.utils.KeyGen.from_file_content","title":"<code>from_file_content(filepath)</code>  <code>staticmethod</code>","text":"<p>Strict: file content hash</p> Source code in <code>src/beautyspot/utils.py</code> <pre><code>@staticmethod\ndef from_file_content(filepath: str) -&gt; str:\n    \"\"\"Strict: file content hash\"\"\"\n    if not os.path.exists(filepath): return f\"MISSING_{filepath}\"\n    hasher = hashlib.md5()\n    # Include extension to distinguish format changes\n    hasher.update(os.path.splitext(filepath)[1].lower().encode())\n    try:\n        with open(filepath, 'rb') as f:\n            while chunk := f.read(65536):\n                hasher.update(chunk)\n    except OSError: return f\"ERROR_{filepath}\"\n    return hasher.hexdigest()\n</code></pre>"},{"location":"reference/utils/#beautyspot.utils.KeyGen.from_path_stat","title":"<code>from_path_stat(filepath)</code>  <code>staticmethod</code>","text":"<p>Fast: path + size + mtime</p> Source code in <code>src/beautyspot/utils.py</code> <pre><code>@staticmethod\ndef from_path_stat(filepath: str) -&gt; str:\n    \"\"\"Fast: path + size + mtime\"\"\"\n    if not os.path.exists(filepath): return f\"MISSING_{filepath}\"\n    stat = os.stat(filepath)\n    identifier = f\"{filepath}_{stat.st_size}_{stat.st_mtime}\"\n    return hashlib.md5(identifier.encode()).hexdigest()\n</code></pre>"}]}